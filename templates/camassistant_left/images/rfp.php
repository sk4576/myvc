<?php error_reporting(0);
/**
 * @version		1.0.0 camassistant $
 * @package		camassistant
 * @copyright	Copyright © 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');

jimport('joomla.application.component.controller');

class rfpController extends JController
{

	function __construct()
	{
		parent::__construct();
	}

	function display()
	{
		parent::display();
	}
	function rfpform()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();

	}
 function editrfp()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();

	}
 function Uploadfile()
	{
		JRequest::getVar('view','rfp');
		parent::display();
	}
	 function reviewrfp()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();

	}
	/* ---Presonal Hired---- */

	function prohired() {

		$sql12="SELECT introtext  FROM #__content where id='154' ";
		$db->Setquery($sql12);
		$data12 = $db->loadResult();
		$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
		$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
		$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext);
		$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext);
		$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext);
		$mailfrom = 'support@myvendorcenter.com';
		$fromname = 'MyVendorCenter.com';
		$assignuseremail = $post['email'];
		$mailsubject = 'Approved Registration';
		$body = $bodytext;
		JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);
	}
function shareinfo() {
if($_POST[load]=='save'){
$db = JFactory::getDBO();
$user = JFactory::getUSer();
$sql = "UPDATE #__users SET showphone='".$_POST['phone']."',showfax='".$_POST['fax']."',	showaddress='".$_POST['address']."',	showcompany='".$_POST['company']."',showemail='".$_POST['email']."' where id='".$user->id."'";
$db->Setquery($sql);
$db->query();
}
JRequest::setVar('view', 'rfp');
parent::display();
	}
	/* ---End Presonal Hired----*/


	/* ---Sow Hired----*/
	function sowhired() {
		$sql12="SELECT vendors_meet_myproject FROM #__emails where id='1'";
		$db->Setquery($sql12);
		$data12 = $db->loadResult();
		$bodytext = str_replace('{CUSTOMER NAME}',$data['name'],$data12);
		$bodytext = str_replace('{PROPERTY}',$data['name'],$bodytext);
		$bodytext = str_replace('{PROPERTY ADDRESS}',$data['name'],$bodytext);
		$bodytext = str_replace('{INDUSTRY}',$data['name'],$bodytext);
		$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext);
		//code to send mail to user
		$config = JFactory::getConfig();
		$mailuser = JFactory::getUser();
		$mailfrom = $config->getValue('config.mailfrom');
		$fromname = $config->getValue('config.fromname');
		$useremail = $mailuser->email;
		$mailsubject = 'Approved Registration';
		$body = $bodytext;
		JUtility::sendMail($mailfrom, $fromname, $useremail, $mailsubject, $body,$mode = 1);
	}

	/* ---End Of Sow Hired----*/

	/* ---End Of Camassitant  Hired----*/
	function hirecamassitant() {
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body,$mode = 1);

	}
	/* ---End Of CamAssitant Hired----*/
function keypath(){
		$db = JFactory::getDBO();
		$rfp_id= $_POST['rfpid'];
		global $mainframe;
		$newrfp_id = 'RFP'.$rfp_id;
		$property_id="SELECT property_id FROM #__cam_rfpinfo where id=".$rfp_id;
		$db->Setquery($property_id);
		$property_id = $db->loadResult();
		//echo '<pre>'; print_r($property_id);
		$property_name ="SELECT property_name FROM #__cam_property where id=".$property_id;
		$db->Setquery($property_name);
		$property_name = $db->loadResult();
		$property_name = str_replace(" ", "_", $property_name);
		echo $key = $property_name.DS.'ProposalReports'.DS.$newrfp_id.DS;
		exit;
	}


	/* ---Delete Line Task----*/
	function deletelinetask() {

	$db = JFactory::getDBO();
$sql='DELETE FROM `#__cam_rfpsow_linetask` WHERE `task_id` = '.$_POST[queryString].'';
$db->setquery($sql);
$db->query();
	}
	/* ---End Of Line task----*/


	function linetaskupload()
	{
	   JRequest::setVar('view', 'rfp');
		parent::display();
		}

	 function pro_hired()
	{



	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
function pro_hired_camassitant()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();
		}

  function sow_hired()
	{

	   JRequest::setVar('view', 'rfp');
		parent::display();
		}
function save_uploadfile()
	{

		$files		= JRequest::getVar( 'uploadfile', '', 'files', 'array' );
		$post	= JRequest::get('post');
		$rebid	= JRequest::getVar('rebid','');
                $pid	= JRequest::getVar('pid','');
		 $db = &JFactory::getDbo();
		$pro="SELECT property_name,tax_id,property_manager_id FROM #__cam_property WHERE id='".$pid."'";
		$db->Setquery($pro);
		$pro_res = $db->loadObjectList();
		$pro_res[0]->property_name = ereg_replace(" ", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace(" ", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("&", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("#", "_", $pro_res[0]->property_name);
		$pro_res[0]->property_name = str_replace("%", "_", $pro_res[0]->property_name);
		
        $p_path= $pro_res[0]->property_name.'_'.$pro_res[0]->tax_id.'/';
        $base_Dir = JPATH_COMPONENT.DS.'doc'.DS;
		//$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'rfp'.DS.'Tasks'.DS;
		$filename = $files['name'];
		$filename = preg_replace("/[&'`:;={}!@#$%^*(?)-+|]/"," ",$filename);	
		$filename = ereg_replace(" ", "_", $filename);
		$filename = str_replace(" ", "_", $filename);
		$filename = str_replace("&", "_", $filename);
		$filename = str_replace("#", "_", $filename);
		$filename = str_replace("%", "_", $filename);
		$filename = str_replace("'", "_", $filename);
		$filename = str_replace(",", "_", $filename);
		
                $dest=$base_Dir.$p_path;
                if(!is_dir($dest))
                mkdir($dest,0777);
		$filepath = $base_Dir.$p_path.$filename;
		move_uploaded_file($files['tmp_name'], $filepath);
		//code to update table
                     $post['property_manager_id'] = $pro_res[0]->property_manager_id;
                    $post['property_id'] = $pid;
	//$post['docPath'] = $_REQUEST['path']."/".$_FILES['file']['name'];
                    $filepath1='components/com_camassistant/doc/'.$p_path.'/'.$filename;
                $post['docPath'] = $filepath1; //modified by lalitha
                $post['docTitle'] = $filename;
                $post['docTitle'] = ereg_replace(' ','_',$post['docTitle']);

                $post['parent'] = '0';
              	$model	=& $this->getModel('rfp');
		//code to update table

                $res = $model->store3($post);
		$user	= JFactory::getUser();

		//$data['task_id'] = $post['task_id'];
		//$data['rfp_id'] = $post['rfp_id'];
		//$data['vendor_id'] = $user->id;
		//$warranty = JRequest::getVar('warranty','');
		$taskid = JRequest::getVar('taskid','');
                $user_id = JRequest::getVar('mid','');
		//if(isset($post['spl']) && $post['spl'] == 'Yes')
		//$data['spl_req'] = 'Yes';
		//else
		//$data['spl_req'] = 'No';
		//$data['upload_doc'] = 'components/com_camassistant/assets/images/rfp/Tasks/'.$filename;
		//$data['Alt_bid'] = $is_Alt;
		//$model = $this->getModel('proposals');
		//if($rebid == 's')
		//$data['id'] = '';
		//$file_id = $model->save_uploadfile($data);
		//$taskid = $data['task_id'];
		$filename = $filename;
		//$rfp_id = $data['rfp_id'];
	 	$task_id = $taskid;
		$user_id = $user_id;
		//$sql_req = $data['spl_req'];
		//$act = $post['act'];
		//$rebid= $post['rebid'];
		//$Proposal_id= $post['Proposal_id'];
		echo "<script language='javascript' type='text/javascript'>
		window.parent.document.getElementById( 'sbox-window' ).close();
		var taskid = 'uploadfile".$taskid."';
		var filename = '".$filename."';
		var rfpid = '".rfp_id."';
		var task = '".$task_id."';
		var rfpid = '".$rfp_id."';
		var docid = '".$file_id."';
		var userid = '".$user_id."';
		var warranty = '".$warranty."';
		var taskid = '".$taskid."';
		var splreq = '".$sql_req."';
		var AltPrp = '".$is_Alt."';
		var act = '".$act."';
		var rebid = '".$rebid."';
		var Proposal_id = '".$Proposal_id."';
		//var data = 'components/com_camassistant/assets/images/rfp/Tasks/'+filename;

		//var old = window.parent.document.getElementById(taskid).innerHTML;
		window.parent.document.getElementById('lineuploads'+taskid).value =filename;
                window.parent.document.getElementById('delimg'+taskid).style.display ='';
                window.parent.document.getElementById('uploadfile'+taskid).innerHTML =filename;



		//window.parent.document.getElementById(taskid).innerHTML = path+del_path+old;
		 </script>";
		 exit;
		//parent::display();
	}
	function update_rfp () {
		//echo "<pre>"; print_r($_REQUEST); exit;
		$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post	= JRequest::getVar("task",'');
		//echo "<pre>"; print_r($_REQUEST); exit;
		$proposalDueDate= JRequest::getVar('proposalDueDate');
		$proposaldate=explode(' ',$proposalDueDate);
		$data['proposalDueDate']=$proposaldate[0];
		$data['proposalDueTime']=$proposaldate[1];
		/*if($proposaldate[1] == '')
		$proposaldate[1] = '12:00';
		if($proposaldate[2] == '')
		$proposaldate[2] = 'pm' ;
		$data['proposalDueTime']=$proposaldate[1].strtoupper($proposaldate[2]);*/
		//$work_perform =  JRequest::getVar('work_perform',array());

		//print_r(count($work_perform)); exit;
		$site_visit =  JRequest::getVar('site_visit',array());
		$data['work_perform'] = JRequest::getVar('work_perform','');
		
		
		
		if (count($site_visit)>1) {
		$data['site_visit']=implode(',',$site_visit);
		} else {
		$data['site_visit']=$site_visit[0];
		}
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$data['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$data['bidders_info']=$bidders_info[1];
		else
		$data['bidders_info']=$bidders_info[2];

		//if($data['rfp_type']=='rfp'){
		//$data['publish']=1;
	   // }else{
    	$data['publish']=0;
       // }
	   //echo "<pre>"; print_r($_REQUEST); exit;
	   $rfp_userid=JRequest::getVar('rfp_userid');

		$data['cust_id']=$rfp_userid;
		/*$createdDate=date('m-d-Y');
		$data['createdDate']=$createdDate;*/
		$update_date=date('m-d-Y');
		$data['update_date']=$update_date;
		$data['bidding'] = JRequest::getVar('bidding');

		$property_id= JRequest::getVar('property_id');
		$industry_id= JRequest::getVar('industry_id');
		$industry_id2 = JRequest::getVar('industry_id2');
		$data['property_id']=$property_id;
		$data['industry_id']=$industry_id;
		$data['industry_id2']=$industry_id2;
		$projectName= JRequest::getVar('projectName');
		$work_perform_other= '';
		$frequency= JRequest::getVar('frequency');
		$startDate= JRequest::getVar('startDate');
		$endDate= JRequest::getVar('endDate');
		$maxProposals= '';
		$data['maxProposals']=$maxProposals;
		$rfp_type= JRequest::getVar('rfp_type');
		/*if($rfp_type=='closed'){
		$rfp_type='rfp';

		}*/
                 $present_date = date('Y-m-d');
        $date1=strtotime($present_date);
        $proposal_date=explode('-',$proposaldate[0]);
        $date2= strtotime($proposal_date[2].'-'.$proposal_date[0].'-'.$proposal_date[1]);
       // print_r($date1);
        // echo $basepath=JURI::root();
       if( $_REQUEST['rfp_type']=='closed' && $date1<$date2){
         // echo 'hi';
          $query23 = "DELETE FROM #__cam_closedzip WHERE rfpid=".$_REQUEST['rfpid'];
		$db->setQuery($query23);
		$db->query();
         $name = "/home/allen/public_html/live/zipdownloads/RFP".$_REQUEST['rfpid'].".zip";
       // readfile("$name");
         chmod("$name",0777);
         unlink("$name");
       }
		$terms= JRequest::getVar('terms');

		if($rfp_type=='review'){
		$data['rfp_type']='draft';
		} else if($rfp_type=='closed'){
		$data['rfp_type']='rfp';
		}
		else if($rfp_type=='Unawarded'){
		$data['rfp_type']='rfp';
		}
		else {
		$data['rfp_type']=$rfp_type;
		}
		//echo "<pre>"; print_r($data); exit;
		//$data['rfp_type']=$rfp_type;
		$data['startDate']=$startDate;
		$data['terms']=$terms;
		//if($rfp_type=='closed'){
		$data['update_rfp']='1';
		//} else {
		//$data['update_rfp']='1';
		//}
		$data['endDate']=$endDate;
		$data['frequency']=$frequency;
		$data['maxProposals']=$maxProposals;
		$data['projectName']=$projectName;
		
		$data['work_perform_other'] = '';
		$rfpid= JRequest::getVar('rfpid');
		//echo "<pre>"; print_r($data); exit;
		$select="SELECT industry_id FROM #__cam_rfpinfo WHERE id='".$rfpid."'";
			$db->Setquery($select);
			$result = $db->loadResult();
		$select_max = "SELECT maxProposals FROM #__cam_rfpinfo WHERE id='".$rfpid."'";
			$db->Setquery($select_max);
			$maxprops = $db->loadResult();
				
		//Insert industry in to rfpindustries table
		/* $sql_updateindustry = "UPDATE #__cam_rfpindustries SET industry_id='".$result."' WHERE rfpid='".$rfpid."'";
		$db->Setquery($sql_updateindustry);
		$db->query(); */
		//Completed

		$TempLineItems=$model->get_tempLineTasks($rfpid);
		$data['id']= $rfpid;
		//$link ='index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid;
		$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		/*$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		echo $data['proposalDueTime']; exit;
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		*/
		$proposaltime = $data['proposalDueTime'];
		$proposaltime=explode(':',$proposaltime);

		$timeminutes =  $proposaltime[0]*60+$proposaltime[1];
		$totalminutes = $datesminutes + $timeminutes;
		$data['secondstime'] =  $totalminutes;

		/*echo "<pre>";
		print_r($data);exit;*/
	if($model->store_update($data)) {
			//$mesg = "<b>RFP submitted successfully<b>";
			$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87';
			$this->setRedirect( $link,$mesg );
		} else {
			$mesg = "Could not added RFP";
		}
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];

		$rfp_id = $rfpid;
		$line_tasks['rfp_id']=$rfp_id;

		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                $line_taskno =  JRequest::getVar('line_taskno',array());
		//echo "<pre>"; print_r($TempLineItems); print_r($task_desc); exit;
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
        //echo '<pre>'; print_r($_REQUEST); exit;
		//code to delete previous tasks
		/*$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();*/
		//code to update taskids by lalitha
		$old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
               // exit;
		$cnt=count($TempLineItems);
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                              //  echo '<pre>'; print_r($linetask_uploads);
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
                               // echo '<pre>'; print_r($line_tasks);
			if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/*echo "<pre>";
				print_r($line_tasks); */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			} //exit;
		}
		$updateditms=implode(',',$updateditems);
		$sql = "UPDATE #__cam_rfpinfo SET modified_lineitems='".$updateditms."' WHERE id='".$rfp_id."'";
		$db->Setquery($sql);
		$db->query();///////

		$req_docprice =  JRequest::getVar('require_docprice',array());
		$hidden_docprice =  JRequest::getVar('hidden_require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());
		//print_r($attachmnent);
		/*$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();*/

		/*****************************************code to validate old,new doc's of RFP /by lalitha *****************************/
		$old_new_docids = JRequest::getVar('old_docids','');
		$old_docids_modified = array_diff($old_new_docids, array(''));
		//echo "<pre>"; print_r($old_new_docids); print_r($old_docids_modified);
		$db = JFactory::getDBO();
		$sql = "SELECT doc_id FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp;
		$db->setQuery($sql);
		$db_docids = $db->loadResultArray();
		$old_docids_modified = array_diff($old_new_docids, array(''));

		for($i=0; $i<count($db_docids); $i++)
		{
			if(!in_array($db_docids[$i],$old_docids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id." AND doc_id=".$db_docids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_docids[$i]." AND item_type='doc' ";
			$db->setQuery($query);
			$db->query();
			}
		}

		/*****************************************code to update doc's table /by lalitha*****************************/
			for($i=0;$i<count($attachmnent);$i++)
			{

					if($attachmnent[$i] == '0'){
					$req_docsow['doc_path']=$attachmnent[$i+1];
					} else {
					$req_docsow['doc_path']=$attachmnent[$i];
					}
					if($hidden_docprice[$i]==1)
					$req_docsow['is_req_docvendors']=1;
					else
					$req_docsow['is_req_docvendors']=0;

					$req_docsow['rfp_id']	=	$rfp_id;
					$req_docsow['doc_id']	=	$old_new_docids[$i];
                                         if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
                                     }
			}
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		 $req_id =  JRequest::getVar('req_id',array());
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');
		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		//For Inserting Special Requirement categories in database for RFP
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{

						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}
				//
			}
		}

		$special = $this->saveinsurance($_REQUEST,$rfp_id);
		$property_id =  JRequest::getVar('property_id');
		$industry_id =  JRequest::getVar('industry_id');
		$userid =  $user->id;
		//updating mail process

	//exit;
		//if($_REQUEST['rfp_type']=='rfp'){

			//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfpid.'&Itemid='.$itemid );
			//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid='.$itemid );
			// $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$_REQUEST['rfp_type'].'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid );

		//}else
		if (($_REQUEST['rfp_type']=='review')||($rfp_type=='rfp')||($rfp_type=='closed') ||($rfp_type=='Unawarded')){
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$rfp_type.'&rfpid='.$rfp_id.'&task=saverfpmsg1&Itemid='.$itemid );
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$data['rfp_type'].'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid );

			//} //else if($rfp_type=='closed'){
			// $msg='RFP Submitted Successfully';
	 		// $this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87',$msg );
			 } else {
			  $msg='RFP Unsubmitted(draft) Successfully';
			 $this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid=88',$msg);
		}

	}
	function submit_rfp()
	{
		global $mainframe;
		$user=JFactory::getUser();  //For $my
		$basepath=JURI::root();
		$db = &JFactory::getDbo();
		$model	=& $this->getModel('rfp');
		$itemid=JRequest::getVar('Itemid',0);
		$show=JRequest::getVar('show','');
		$post = JRequest::get('post');
		/*$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		echo "<pre>"; print_r($linetaskname);print_r($is_req_taskvendors); exit;*/
		$proposaldate=explode(' ',$post['proposalDueDate']);
		$post['proposalDueDate']=$proposaldate[0];
		$post['proposalDueTime']=$proposaldate[1];
		$post['work_perform'] = JRequest::getVar('work_perform','');
		$post['work_perform_other'] = '' ;
		$site_visit =  JRequest::getVar('site_visit',array());
		$bidders_info =  JRequest::getVar('bidders_info',array());
		if($site_visit[0]=='Required prior to bidding')
		$post['bidders_info']=$bidders_info[0];
		else if($site_visit[0]=='Recommended')
		$post['bidders_info']=$bidders_info[1];
		else
		$post['bidders_info']=$bidders_info[2];
		//$post['work_perform']=$work_perform[0];

		
		/*if (count($site_visit)>1) {
		$post['site_visit']=implode(',',$site_visit);
		} else {
		$post['site_visit']=$site_visit[0];
		}*/
		$post['site_visit']=$site_visit[0];
		if($post['rfp_type']=='review'){
		$post['publish']=0;
	    }else{
    	$post['publish']=1;
        }
		$rfp_userid=JRequest::getVar('rfp_userid');
		 if($rfp_userid){
		$post['cust_id']=$rfp_userid;
		} else {
		$post['cust_id']=$user->id;
		}
		$createdDate=date('m-d-Y');
		$post['createdDate']=$createdDate;
		$updatedate=date('m-d-Y');
		$post['update_date']=$updatedate;
		$post['bidding'] = JRequest::getVar('bidding');
		$property_id=JRequest::getVar('property_id');
		//To get the property owner
			$get_pmid="SELECT property_manager_id FROM #__cam_property WHERE id='".$property_id."'";
			$db->Setquery($get_pmid);
			$post['cust_id'] = $db->loadResult();
		//Completed
		$rfpfor = JRequest::getVar('rfpfor');
		$post['rfpfor'] = $rfpfor;
		
		$industry_id=JRequest::getVar('industry_id');
		$industry_id2=JRequest::getVar('industry_id2');
		$choose_tasks=JRequest::getVar('choose_tasks');
		if($post['choose_tasks2'])
		$choose_tasks=$post['choose_tasks2'];
		if($post['choose_tasks3'])
		$choose_tasks=$post['choose_tasks3'];
		$amount=$post['liabilityInsuranceAmount'];
		//echo "<pre>"; print_r($choose_tasks); exit;
		$rfpid= JRequest::getVar('rfpid');
		$post['id']= $rfpid;
		$post['rfp_indus_data']=$_SESSION['rfp']['industry'];
		$post['update_rfp']='0';
		// echo "<pre>"; print_r($post); exit;
		$from_name=$user->name;
		$from_email=$user->email;
		$rfp_type =  JRequest::getVar('rfp_type');
		if($rfp_type=='review'){
		$post['rfp_type']= 'draft';
		} else {
		$post['rfp_type']= $rfp_type;
		}
		$post['choose_tasks']= $choose_tasks;
		//echo "<pre>"; print_r($post); exit;
		/*if($post['id'] == '')
		$post['id'] = str_pad(mt_rand(0, 999999), 6, '0', STR_PAD_LEFT); */
		list($month, $day, $year) = split('[/.-]', $data['proposalDueDate']);
		$datesminutes = strtotime($year."-".$month."-".$day);
		/*$hr_min = substr($data['proposalDueTime'], 0, -2);  // returns "7:00"
		$am_pm = substr($data['proposalDueTime'], -2);    // returns "AM" OR "PM"
		echo $data['proposalDueTime']; exit;
		if($am_pm == 'PM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		$x = substr($due_time, 0, 2);
		if($x != 12)
		$hr = $hr + 12;
		}
		else if($am_pm == 'AM')
		{
		$min = substr($hr_min, -2);
		$hr = substr($hr_min, 0, -3);
		}
		*/
		$proposaltime = $data['proposalDueTime'];
		$proposaltime=explode(':',$proposaltime);

		$timeminutes =  $proposaltime[0]*60+$proposaltime[1];
		$totalminutes = $datesminutes + $timeminutes;

		$post['secondstime'] =  $totalminutes;

	if($model->store($post)) {

			$mesg = "<font color='red' size='3'><b>RFP stored successfully<b></font>";
		} else {
			$mesg = "Could not added RFP";
		}
		//added by lalitha
		if(!$rfpid)
		{
			/*$db = JFactory::getDBO();
			$sql = "SELECT max(id) FROM #__cam_rfpinfo ";
			$db->Setquery($sql);
			$rfpinfo_id = $db->loadResult();*/
			$rfpinfo_id = $db->insertid();
			$random_id 	 = str_pad(mt_rand(1, 999999), 6, '1', STR_PAD_LEFT);
			$upd_sql = 'UPDATE #__cam_rfpinfo set id='.$random_id.' WHERE id ='.$rfpinfo_id;
			$db->Setquery($upd_sql);
			$db->query();

			//Insert industry in to rfpindustries table
			/* $industry_new=JRequest::getVar('industry_id','');
			$insert_sql = "insert into #__cam_rfpindustries values ('','".$random_id."','".$industry_new."')";
			$db->SetQuery($insert_sql);
			$db->query(); */
			//Completed

		}
		$rfpinfo_id1 = $db->insertid();
		//print_r($rfpinfo_id1); exit;
		//added by lalitha
		if(!$rfpid)
		$rfp_id = $random_id;
		else
		$rfp_id = $rfpid;
		/* $sql_updateindustry = "UPDATE #__cam_rfpindustries SET industry_id='".$industry_id."' WHERE rfpid='".$rfp_id."'";
		$db->Setquery($sql_updateindustry);
		$db->query();*/
		$line_tasks['rfp_id']=$rfp_id;
		$task_desc =  JRequest::getVar('task_desc',array());
		$linetaskname =  JRequest::getVar('linetaskname',array());
		$rfpreference =  JRequest::getVar('rfpreference',array());
		$is_req_taskvendors =  JRequest::getVar('is_req_taskvendors',array());
		$hidden_taskvendors =  JRequest::getVar('hidden_taskvendors',array());
		$linetask_uploads =  JRequest::getVar('linetask_uploads',array());
                 $line_taskno =  JRequest::getVar('line_taskno',array());
	//echo "<pre>"; print_r($is_req_taskvendors); exit;
		//code to delete previous tasks
		 $old_new_taskids = JRequest::getVar('old_taskids','');
		$rfp = JRequest::getVar('rfpid','');
		$db = JFactory::getDBO();
		$sql = "SELECT task_id FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp;
		$db->setQuery($sql);
		$db_taskids = $db->loadResultArray();

		$old_taskids_modified = array_diff($old_new_taskids, array(''));

		for($i=0; $i<count($db_taskids); $i++)
		{
			if(!in_array($db_taskids[$i],$old_taskids_modified))
			{
			//code to delete taskid from  #__cam_rfpsow_linetask
			$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id." AND task_id=".$db_taskids[$i];
			$db->setQuery($query);
			$db->query();
			//code to delete taskid from  #__cam_rfpsow_docs_lineitems_prices
			$query = "DELETE FROM #__cam_rfpsow_docs_lineitems_prices WHERE rfp_id=".$rfp_id." AND item_id=".$db_taskids[$i]." AND item_type='task' ";
			$db->setQuery($query);
			$db->query();
			}
		}
		// end of code to update task ids by lalitha
		$updateditems=array();
		$k=0;
		//code to delete previous tasks
		//$query = "DELETE FROM #__cam_rfpsow_linetask WHERE rfp_id=".$rfp_id;
		//$db->setQuery($query);
		//$db->query();
		//print_r($rfp_id); exit;
		//end of code
		//echo "<pre>"; print_r($_REQUEST);
		if(count($line_taskno)>0)
		{
			for($i=0;$i<count($line_taskno);$i++)
			{

                             $task_desc =  JRequest::getVar('task_desc_'.$line_taskno[$i] ,array());

                             $linetaskname =  JRequest::getVar('linetaskname_'.$line_taskno[$i] ,array());
                              $rfpreference=  JRequest::getVar('rfpreference_'.$line_taskno[$i] ,array());
                            $linetask_uploads =  JRequest::getVar('linetask_uploads_'.$line_taskno[$i], array());
                            $is_req_taskvendors=  JRequest::getVar('is_req_taskvendors_'.$line_taskno[$i] ,array());
                            $hidden_taskvendors=  JRequest::getVar('hidden_taskvendors_'.$line_taskno[$i] ,array());

				$line_tasks['task_id']=$old_new_taskids[$i]; //echo '<br/>';

				$line_tasks['task_desc']=$task_desc[0];
				$line_tasks['linetaskname']=$linetaskname[0];
				$line_tasks['rfpreference']=$rfpreference[0];
				//$line_tasks['is_req_taskvendors']=$is_req_taskvendors[$j];
                                  //echo '<pre>'; print_r($linetask_uploads);
                                $result = array_filter( $linetask_uploads, 'strlen' );
                               //  echo '<pre>'; print_r($result);
                                if($linetask_uploads!=''){
				$line_tasks['taskuploads']=implode(',', $result);
                                }
				/*if($js_req_taskvendors[$j+1] == ''){
				$line_tasks['is_req_taskvendors'] = 0;
				} else {
				$line_tasks['is_req_taskvendors'] = $js_req_taskvendors[$j+1];
				}*/
				//$k=$j+1;
                               // echo '<pre>'; print_r($line_tasks);
				if($hidden_taskvendors==1 || $is_req_taskvendors[0]==1)
				$line_tasks['is_req_taskvendors']=1;
				else
				$line_tasks['is_req_taskvendors']=0;


				$line_tasks['rfp_id']=$rfp_id;
				//
				$lastinsid=$db->insertid();
				$tag1=0; $tag2=0; $tag3=0;
				if($i<$cnt)
				{
					$tag1=strcmp($linetaskname,$linetaskname);
					$tag2=strcmp($task_desc,$task_desc);
					$tag3=strcmp($rfpreference,$rfpreference);
					if($tag1!=0 || $tag2!=0 || $tag3!=0)
					$line_tasks['is_modified'] = 1;
					else
					$line_tasks['is_modified'] = 0;
					//$updateditems[]=$lastinsid;
				}
				else
				$line_tasks['is_modified'] = 0;
				/* echo "<pre>";
				print_r($line_tasks);  */
				if($model->tasks_store($line_tasks))
				{
					$mesg = "Tasks stored successfully";
				} else {
					$mesg = "Error saved";
				}
                       // }

			}  //exit;
		}
		//print_r($_REQUEST);
		$require_docprice =  JRequest::getVar('require_docprice',array());
		$hidden_docprice =  JRequest::getVar('hidden_require_docprice',array());
		$attachmnent =  JRequest::getVar('attachmnent',array());

		$query = "DELETE FROM #__cam_rfpsow_docs WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();

			for($i=0;$i<count($attachmnent);$i++)
			{

				/*if($require_docprice[$i+1] == ''){

				$req_docsow['is_req_docvendors']=0;
				}  else {
				$req_docsow['is_req_docvendors']= $require_docprice[$i+1];
				}*/
					if($hidden_docprice[$i]==1)
					$req_docsow['is_req_docvendors']=1;
					else
					$req_docsow['is_req_docvendors']=0;

					$req_docsow['doc_path']=$attachmnent[$i];
					//}
					$req_docsow['rfp_id']=$rfp_id;
				//echo "<pre>"; print_r($req_docsow);
                                         if($req_docsow['doc_path']){
					if($model->reqdocs_store($req_docsow)) {
					$mesg = "Documents stored successfully";
					} else {
						$mesg = "Error saved";
					}
				}
			}// exit;
		//For Inserting Spl reqs
		$req_parentid =  JRequest::getVar('req_parentid',array());
		$sub_req_id =  JRequest::getVar('sub_req_id',array());
		$req_id =  JRequest::getVar('req_id',array());
		$otherValue1 =  JRequest::getVar('otherValue1');
		$otherValue2 =  JRequest::getVar('otherValue2');
		$otherValue3 =  JRequest::getVar('otherValue3');
		$otherValue =  $otherValue1.'/'.$otherValue2.'/'.$otherValue3;
		$liabilityInsuranceAmount =  JRequest::getVar('liabilityInsuranceAmount');

		//code to delete previous special requirements
		$db = JFactory::getDBO();
		$query = "DELETE FROM #__cam_rfpreq_info WHERE rfp_id=".$rfp_id;
		$db->setQuery($query);
		$db->query();
		if(count($req_parentid)>0)
		{
			for($i=0;$i<count($req_parentid);$i++)
			{
				if(count($sub_req_id[$req_parentid[$i]])>0)
				{
					for($j=0;$j<count($sub_req_id[$req_parentid[$i]]);$j++)
					{
						if(count($req_id[$sub_req_id[$req_parentid[$i]][$j]])>0)
						{
							for($k=0;$k<count($req_id[$sub_req_id[$req_parentid[$i]][$j]]);$k++)
							{
								$splreq_rfp['rfp_id']=$rfp_id;
								$splreq_rfp['req_parentid']=$req_parentid[$i];
								$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
								$splreq_rfp['req_id']=$req_id[$sub_req_id[$req_parentid[$i]][$j]][$k];
								//
								if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
								$splreq_rfp['price']= $otherValue;
								//
								if($sub_req_id[$req_parentid[$i]][$j]=='12')
								$splreq_rfp['price']=$liabilityInsuranceAmount;
								//
								if($model->rfpsplreqs_store($splreq_rfp)) {

								}
							}
						} else {

							$splreq_rfp['rfp_id']=$rfp_id;
							$splreq_rfp['req_parentid']=$req_parentid[$i];
							$splreq_rfp['req_subparentid']=$sub_req_id[$req_parentid[$i]][$j];
							$splreq_rfp['req_id']=0;
							//
							if($req_id[$sub_req_id[$req_parentid[$i]][$j]][$k]=='14')
							$splreq_rfp['price']= $otherValue;
							//
							if($sub_req_id[$req_parentid[$i]][$j]=='12')
							$splreq_rfp['price']=$liabilityInsuranceAmount;
							//
							if($model->rfpsplreqs_store($splreq_rfp)) {

							}
						}
						/*if($model->rfpsplreqs_store($splreq_rfp)) {

						}*/
					}
				} else {
					$splreq_rfp['rfp_id']=$rfp_id;
					$splreq_rfp['req_parentid']=$req_parentid[$i];
					$splreq_rfp['req_subparentid']=0;
					$splreq_rfp['req_id']=0;
					if($model->rfpsplreqs_store($splreq_rfp)) {

					}
				}

			}

		}
		// Code to save the special requirement
		$special = $this->saveinsurance($_REQUEST,$rfp_id);
		//Completed
		if($_REQUEST['rfp_type']=='review'){
		$proposals = '';
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$post['rfp_type'].'&rfpid='.$rfp_id.'&task=saverfpmsg1&Itemid='.$itemid );
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&industry_id='.$industry_id.'&property_id='.$property_id.'&show='.$show.'&rfp_type='.$post['rfp_type'].'&choose_tasks='.$choose_tasks.'&amount='.$amount.'&task=reviewrfp&rfpid='.$rfp_id.'&Itemid='.$itemid );

		}else{
	 		// $this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&rfp_type='.$post['rfp_type'].'&task=saverfpmsg1&Itemid='.$itemid );
			$msg = 'You have created Draft RFP successfully.'; 
			$this->setRedirect( 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=125',$msg );	
		}

	}
	function saverfpmsg()
	{
			global $mainframe;
		//echo "<pre>"; print_r($_REQUEST); exit;
			$user=JFactory::getUser();  //For $my
			$userid = $user->id;
			$basepath=JURI::root();
			$db = &JFactory::getDbo();
			$model	=& $this->getModel('rfp');
			$itemid=JRequest::getVar('Itemid',0);
			$show=JRequest::getVar('show','');
			$post = JRequest::get('post');
			//echo "<pre>"; print_r($post);
			$rfpid= JRequest::getVar('rfpid');
			$select="SELECT rfp_type,property_id,cust_id,industry_id,industry_id2,choose_tasks FROM #__cam_rfpinfo WHERE id='".$rfpid."'";
			$db->Setquery($select);
			$result = $db->loadObjectlist();
			//echo "<pre>"; print_r($result[0]->rfp_type); exit;
			$property_id=$result[0]->property_id;
			$industry_id=$result[0]->industry_id;
			$industry_id2=$result[0]->industry_id2;
			$userid=$result[0]->cust_id;
			$choose_tasks=$result[0]->choose_tasks;
			//$choose_tasks=$post['choose_tasks'];
                        $mail_res = $model->sendmailtomanager($rfpid);
			$amount= $post['amount'];
			//echo "<pre>"; print_r($_REQUEST); exit;
			//$rfpid= JRequest::getVar('rfpid');
			$db = JFactory::getDBO();
			$sql = "UPDATE #__cam_rfpinfo SET rfp_type='rfp' WHERE id='".$rfpid."'";
			$db->Setquery($sql);
			$db->query();
			$updaterfp="SELECT R.update_rfp,R.projectName,P.property_name FROM #__cam_rfpinfo as R LEFT JOIN #__cam_property as P ON P.id=R.property_id  WHERE R.id='".$rfpid."'";
			$db->Setquery($updaterfp);
			$status12 = $db->loadObjectlist();

			if($choose_tasks=='Engineer')
			$industry_id=47;
			if($choose_tasks=='Architect')
			$industry_id=23;
			//print_r($industry_id);
			$review="SELECT rfp_review FROM #__cam_configuration";
			$db->Setquery($review);
			$review_on = $db->loadResult();
				$today = date('Y-m-d H:i:s');
			$sql = "UPDATE #__cam_rfpinfo SET approve_date='".$today."',note_email = 0,publish='1' where id='".$rfpid."'";
			$db->Setquery($sql);
			$success =$db->query();
			$model->rfp_requirements_validations($industry_id,$userid,$property_id,$rfpid);
			if($review_on=='off'){

			$today = date('Y-m-d H:i:s');
			$sql = "UPDATE #__cam_rfpinfo SET approve_date='".$today."',note_email = 0,publish='1' where id='".$rfpid."'";
			$db->Setquery($sql);
			$success =$db->query();

			$model->rfp_requirements_validations($industry_id,$userid,$property_id,$rfpid);
			}

		$notification = "SELECT introtext  FROM #__content where id='190'";
		$db->setQuery($notification);
		$body = $db->loadResult();


		$username=$user->name.' '.$user->lastname;
		$mailfrom='support@myvendorcenter.com';
		$fromname='MyVendorCenter.com';
		//$assignuseremail='support@myvendorcenter.com';
		$rfpemail='rfp@myvendorcenter.com';
		//if($status12[0]->update_rfp=='1'){
		//$mailsubject='Addendum to RFP '.sprintf('%06d', $rfpid);
		//} else {
		$mailsubject='RFP Notification';
		//}
		$rfp_id=sprintf('%06d', $rfpid);
		$status12[0]->property_name = str_replace('_',' ',$status12[0]->property_name);
		$body = str_replace('{RFP NUMBER}', $rfpid, $body);
		$body = str_replace('{PROPERTY NMAE}', $status12[0]->property_name, $body);
		$body = str_replace('{PROJECT NAME}', $status12[0]->projectName, $body);
		$body = str_replace('{USERNAME}', $username, $body);

		//JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $mode = 1);
		JUtility::sendMail($mailfrom, $fromname, $rfpemail, $mailsubject, $body, $mode = 1);
		$to = 'rize.cama@gmail.com';
		JUtility::sendMail($mailfrom, $fromname, $to, $mailsubject, $body, $mode = 1);
		//To send the mail to manager
		//$mail_res = $model->sendmailtomanager($rfpid);
		//Completed
		//To send the invitations
	//$total_invites = "SELECT DISTINCT(vendorid),mail FROM #__rfp_invitations  where rfpid=".$rfpid." and mail='no' ";
	//$db->Setquery($total_invites);
	//$totalinvites = $db->loadObjectList();
	
	$total_invites = "SELECT DISTINCT(proposedvendorid),bidfrom FROM #__cam_vendor_proposals  where rfpno=".$rfpid." and bidfrom='admin' ";
	$db->Setquery($total_invites);
	$totalinvites = $db->loadObjectList();
	
//	echo "<pre>"; print_r($totalinvites ); exit;
	for( $v=0; $v<count($totalinvites); $v++ ){ 	
	$v_company = "SELECT u.company_name, v.email, v.ccemail, v.subscribe  FROM #__cam_vendor_company as u, #__users as v where u.user_id=".$totalinvites[$v]->proposedvendorid." and u.user_id=v.id ";
	$db->Setquery($v_company);
	$vendor_companyname = $db->loadObject();
	$v_companyname = $vendor_companyname->company_name ;
    $vemail = $vendor_companyname->email ;
	$ccemail = $vendor_companyname->ccemail ;
    $subscribe = $vendor_companyname->subscribe ;     
	$pdata = "SELECT u.property_name, v.projectName, v.proposalDueDate, v.proposalDueTime, v.cust_id FROM #__cam_property as u, #__cam_rfpinfo as v where u.id=v.property_id and v.id=".$rfpid." ";
	$db->Setquery($pdata);
	$rfpdetails = $db->loadObject();
	//To get the company name
	$namemanager = "SELECT comp_name FROM #__cam_customer_companyinfo  where cust_id=".$rfpdetails->cust_id." ";
	$db->Setquery($namemanager);
	$managaercname = $db->loadResult();
    $rfptime = $rfpdetails->proposalDueDate.' '.$rfpdetails->proposalDueTime ;
        
    $customerdata = "SELECT u.comp_name FROM #__cam_customer_companyinfo as u, #__cam_rfpinfo as v where v.cust_id=u.cust_id and v.id=".$rfpid." ";
	$db->Setquery($customerdata);
	$cust_coname = $db->loadResult();
	
	// To get the manager name
	$manager_name = "SELECT name, lastname, email FROM #__users where id=".$rfpdetails->cust_id." ";
	$db->Setquery($manager_name);
	$manager_details = $db->loadObject();
	$man_fullname = $manager_details->name.' '. $manager_details->lastname ;
	//Completed
	
    if($subscribe == 'yes'){
    $email_data = "SELECT introtext  FROM #__content where id='248' ";
	}
	else{
	$email_data = "SELECT introtext  FROM #__content where id='258' ";
	}
	$db->Setquery($email_data);
	$data = $db->loadResult();
                
    $body = str_replace('{VENDOR}',$v_companyname,$data);
	$body = str_replace('[RFP #]',$rfpid,$body);
	$body = str_replace('{PNAME}',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[communityname]',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[managername]',$managaercname,$body);
	$body = str_replace('[Reference Name]',$rfpdetails->projectName,$body);
	$body = str_replace('{PROJECTNAME}',$rfptime,$body);
	$body = str_replace('{CAMFIRM}',$cust_coname,$body);
	$body = str_replace('{managerfullname}',$man_fullname,$body);
	//$mailfrom = 'support@myvendorcenter.com';
	$mailfrom = $manager_details->email ;
	$fromname = $cust_coname;
	$mailsubject = "You've received a Project Invitation";
    $support='vendoremails@myvendorcenter.com';
        //Check is the vendor declines the project or not
		$decline_not = "SELECT not_interested FROM #__cam_vendor_availablejobs  where rfp_id=".$rfpid." and user_id=".$totalinvites[$v]->proposedvendorid." ";
		$db->Setquery($decline_not);
		$decline_field = $db->loadResult();
	if($decline_field != '2') {
	JUtility::sendMail($mailfrom, $fromname, $vemail, $mailsubject, $body,$mode = 1);
    JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body,$mode = 1);
	//To send the mails to CC
	$cclist = explode(';',$ccemail);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body,$mode = 1);
		}
		} 
	}	
	//Update the mail field as empty
	$update_mail = "UPDATE #__rfp_invitations SET mail='' WHERE vendorid='".$totalinvites[$v]->vendorid."'";
	$db->Setquery($update_mail);
	$db->query(); 
		
	} //Close invitations for loop	
		
		//Completed
		$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&task=successinvites&Itemid=199' );
		//JRequest::setVar('view', 'rfp');
		//parent::display();
	}
	//
	function checkImage($fname,$tempname , $folder = 'com_camassistant') {
		//echo "hi iam here";exit;
		/*Uploading Image*/
		ini_set('upload_max_filesize','20');
		  if($fname != '')
		  {
			  $pos = strrpos($fname,'.');
			  $fileExt = substr($fname,($pos+1),4);
			  $fileName = substr($fname,0,($pos));
			  $aryFileExt = array('jpeg','JPEG','JPG','jpg','GIF','gif','PNG','png','pdf','xls','docs','txt','php');
			  if(in_array($fileExt,$aryFileExt) )
			  {
				   $file = $fileName.time().".".$fileExt;
				   $file = str_replace(' ','_',$file);
				   copy($tempname, 'components/com_camassistant/assets/images/rfp/'.$file);
				   return $file;
			  }
			  else
			  {
				$msg="File format was not supported";
				$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&task=rfp',$msg );
			  }
		 }
	 }

	function addproperty()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}

    function saveindustry()
	{
		$db = JFactory::getDBO();
		echo 'Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"';

$db->setQuery('Select * FROM #__rsform_properties as a, #__rsform_forms as b,#__rsform_components as c  WHERE c.ComponentTypeId=a.ComponentId and b.FormId=a.ComponentId and  a.PropertyName="NAME"  and b.camindustry="'.$_POST[formid].'"');
$db->query();
$cam=$db->loadobjectlist();

    }



function showindustryform()
{

require_once(''.JPATH_BASE.'/components/com_rsform/controller/adapter.php');
require_once(''.JPATH_BASE.'/components/com_rsform/controller/functions.php');
require_once(''.JPATH_BASE.'/components/com_rsform/controller/validation.php');

$RSadapter = new RSadapter();
$GLOBALS['RSadapter'] = $RSadapter;

$GLOBALS['ismodule'] = 'local';
$db = JFactory::getDBO();
//require backend language file
require_once(_RSFORM_FRONTEND_ABS_PATH.'/languages/'._RSFORM_FRONTEND_LANGUAGE.'.php');
$db->setQuery("Select `FormId`,`line_item_price` FROM #__rsform_forms  WHERE  camindustry='".$_GET[formid]."'");
$db->query();
$cam=$db->loadobject();
$formId=$cam->FormId;
//If Formid exists
if($_GET['direct']=='form'){
$formId=$_GET['formid'];
}
echo '<div class="rsform">';
	$output = '';
	$RSadapter = $GLOBALS['RSadapter'];

	if(isset($_SESSION['form'][$formId]['thankYouMessage']) && !empty($_SESSION['form'][$formId]['thankYouMessage']))
	{

		$output .= RSshowThankyouMessage($formId);
	}
	else
	{
		if(!empty($_POST['form']['formId']))
		{


			$invalid = RSprocessForm($formId);

$output .='<script type="text/javascript">';
for($i=2; $i<=$_GET[lcnt]; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";

if($_GET[task]=='editrfp'){
for($i=1; $i<='7'; $i++){
$output .='<script type="text/javascript"> parent.removeEvent_edit('.$i.'); </script>';
}
}
$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION[rfp][industry]."' AND FieldValue!='' ORDER BY `SubmissionId` ASC");
$industrys = $db->loadobjectlist();
$os = array("Submit", "formId");
$i=0;
$j=1;
foreach($industrys as $industry){
if (!in_array($industry->FieldName, $os)) {
if($industry->FieldValue && $industry->FieldValue!='PLEASE SELECT' && $industry->FieldValue!='Select')
$linetask.=$industry->FieldName.':'.$industry->FieldValue.' , ';


if($industry->FieldName==$lit&&$industry->FieldValue=='True'){
$linetask=eregi_replace('Linetask','',$linetask);
$linetask=eregi_replace('True','',$linetask);
$linetask=eregi_replace('Select','',$linetask);
$linetask1=RScleanVar($linetask);
$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
$i++;
$j++;
}
unset($linetask);
}
}
}
$linetask1=RScleanVar($linetask);

$linetask1=str_replace(',','\n',$linetask1);
$linetask1=str_replace('<br>','\n',$linetask1);
$linetask1=str_replace('PLEASE SELECT','',$linetask1);
$linetask=str_replace('submit:','',$linetask1);
if($linetask){
$output .= '<script type="text/javascript">';
$output .= 'parent.addEvent1();';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->FieldValue.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$linetask.'";	</script>';
}

	$output .= '<script type="text/javascript">
window.parent.document.getElementById( "sbox-window" ).close();
		</script>';




			if($invalid)
			{
				//the invalid variable is returned
				$output .= RSshowForm($formId, $_POST['form'], $invalid);
			}
		}
		else
		{


			if(isset($_SESSION['form'][$formId]['thankYouMessage']) && empty($_SESSION['form'][$formId]['thankYouMessage']))
			{
				unset($_SESSION['form'][$formId]['thankYouMessage']);

				//is there a return url?
				$db = JFactory::getDBO();
				$db->setQuery("SELECT ReturnUrl FROM #__rsform_forms WHERE `formId`='".$formId."'");
				$returnUrl = $db->loadResult();
				if(!empty($returnUrl))
				{
					if(!isset($_SESSION['form'][$formId]['submissionId']))$_SESSION['form'][$formId]['submissionId'] = '';
					$returnUrl = RSprocessField($returnUrl,$_SESSION['form'][$formId]['submissionId']);
					unset($_SESSION['form'][$formId]['submissionId']);

					$RSadapter->redirect($returnUrl);
				}

				$output .= _RSFORM_FRONTEND_THANKYOU;
if($_GET[lcnt]){
$output .='<script type="text/javascript"> ';
for($i=2; $i<=$_GET[lcnt]; $i++){
$output .=" parent.removeEventedit('2'); ";
}
$output .=" </script>";
}

$db->setQuery("Select * from #__rsform_submission_values where SubmissionId='".$_SESSION[rfp][industry]."' AND FieldValue!='' ORDER BY `SubmissionValueId` ASC");
$industrys = $db->loadobjectlist();

$i=1;
$output .= '<script type="text/javascript">';
foreach($industrys as $industry){
if($i>1){
$output .= 'parent.addEvent1();';
}
if($industry->required_vendor){
$output .= 'window.parent.document.getElementById("price'.$i.'").checked ="checked";';
$output .= 'window.parent.document.getElementById("hidden_price'.$i.'").value ="1";';
}




$lineitem_value=explode(',',$industry->FieldValue);
foreach($lineitem_value as $lineitem){
if(!strstr($lineitem,'{')){
$line_desc.= $lineitem.'\n\n';
}
}

if(strstr($line_desc,'Frequency')){
//$freq="Frequency: ".$industry->Frequency.'\n\n';
$line_desc=$freq.$line_desc;
$frequency='See below';
}
if($frequency){
//$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$frequency.'";';
}elseif($industry->Frequency){
//$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="'.$industry->Frequency.'";';
}else{
//$output .= 'window.parent.document.getElementById("frequency'.$i.'").value ="N/A";';
}

$line_desc=str_replace('#split#',',',$line_desc);
$line_desc=str_replace('#splityes#','\n\n',$line_desc);
//$line_desc='Fertilization,Shade Trees Flowering Trees Palm Trees Accent Trees,';
$output .= 'window.parent.document.getElementById("title_task'.$i.'").value ="'.$industry->line_title.'";';
$output .= 'window.parent.document.getElementById("line_taskdesc'.$i.'").value ="'.$line_desc.'";';
//$output .=' parent.autogrow();';
unset($line_desc);
unset($frequency);
$i++;
}

$output .= 'window.parent.document.getElementById( "sbox-window" ).close();
		</script>';




			}
			$output .= RSshowForm($formId);
		}
	}



echo $output;
echo '</div>';
   }
	//
	function submit_property()
	{
	//echo "<pre>"; print_r($_REQUEST); exit;
		global $mainframe;
		$db = JFactory::getDBO();
		$model = $this->getModel('property');
		$post	= JRequest::get('post');
		$user=JFactory::getUser();  //For $my
		$taxids=$model->getProperty_TaxIDs();
		$tax_ids=array();
		for($i=0;$i<count($taxids);$i++)
		$tax_ids[$i]=$taxids[$i]->tax_id;
		/*echo "<pre>";
		print_r($post); exit;*/
		$post['tax_id'] = $post['tax_id1']."-".$post['tax_id2'];
		if(in_array($post['tax_id'],$tax_ids))
		{
			$err_msg="<span style='text-align:justify;font-size:11px;'>This Property is already registered with our system. Please contact your board/Management Company to determine your Property's Administrator on CAMassistant.com. If you have any  additional questions, please email us at properties@CAMassistant.com</span>";
			$mainframe->Redirect('index.php?option=com_camassistant&controller=rfp&task=addproperty&err_msg='.$err_msg );
		}
		/*echo "123456<pre>";
		print_r($rows); exit;*/
		$post['id']='';
		$post['property_manager_id']=$user->id;

		if($user->id)
		{
				//echo "<pre>"; print_r($post); exit;
				if ($model->store($post)) {
				$pid=$db->insertid();
				$propertyList=$model->getProperties();
				$row1[0]->value = "";
				$row1[0]->text = "-Select Propety-";
				$row1[1]->value = 'addp';
				$row1[1]->text = "Add Propety";
				$propertyList=array_merge($row1,$propertyList);
				//sleep(5);
				$plist=JHTML::_('select.genericlist', $propertyList, 'property_id', 'size="1" class="inputbox "    onchange="addproperty(this.value);""', 'value', 'text', $pid);
				?>
				<script type="text/javascript">
				window.parent.document.getElementById("prop_list").innerHTML ='<?php echo $plist; ?>';
				window.parent.document.getElementById( 'sbox-window' ).close();
				</script>
				<?php
				echo '<script language="javascript">window.parent.document.getElementById( "sbox-window" ).close(); window.parent.location.reload();</script>';
				exit(0);
				/*echo '<script language="javascript">window.parent.location.reload();</script>';
				exit(0);*/
			} else {
				echo "<font color='red'>Error Saving Property (ie. Property Name or Tax-Id entry might be duplicated )</font>";
				echo '<script language="javascript">window.parent.location.reload();</script>';exit(0);
			}
		//$this->setRedirect( 'index.php?option=com_camassistant&controller=rfp&amp;task=addproperty&msg='.$msg );
		} else {
			echo "<font color='red'>Your session has been expired.Please login again</font>";
			echo '<script language="javascript">window.parent.document.getElementById( "sbox-window" ).close();</script>';
			exit(0);
		}

	}
	//For pop up line tasks check list
	function pop_linetasks()
	{
	 	JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	function cancelrfp()
	{
		JRequest::setVar('view', 'rfp');
		parent::display();
	}
	//
	//
	function updatestatus_rfp()
	{
		$db = JFactory::getDBO();
		$user=JFactory::getUser();
		 $userid = $user->id;
		$email=$user->email;
		$rfpno= JRequest::getVar("rfpid",'');
		$jobs = "SELECT id FROM  #__cam_vendor_availablejobs WHERE rfp_id=".$rfpno;
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $jobs );
		$id = $db->loadResult();

		$user=JFactory::getUser();
		$pro_id = "SELECT property_id FROM #__cam_rfpinfo where id=".$rfpno;
		$db->setQuery( $pro_id );
		$property_id = $db->loadResult();

		if(!$id){
		$db = JFactory::getDBO();
		$sql = "insert into #__cam_vendor_availablejobs values ('','".$rfpno."','".$user->id."','".$property_id."','0')";
					$db->SetQuery($sql);
					$db->query();
					$id= $db->insertid();
		}
		if($id){
		$db = JFactory::getDBO();
		 $sql = "UPDATE #__cam_vendor_availablejobs SET status='0' WHERE id=".$id;
		$db->Setquery($sql);
		$db->query();

		}
	//print_r($id); exit;

		//print_r($_REQUEST); exit;
		//if($_REQUEST['rfp_type']=='closed')
		//{
			//$rfp_type='Unawarded';
			$link="index.php?option=com_camassistant&controller=rfpcenter&task=submitedrfp&Itemid=87&msg=msg";
			//$link='index.php?option=com_camassistant&controller=rfpcenter&task=unawardrfp&Itemid='.$_REQUEST['Itemid'];
		//} else {
			//$rfp_type='draft';

			//$link="index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid=88&msg=msg";
			//$link='index.php?option=com_camassistant&controller=rfpcenter&task=unsubmittedrfp&Itemid='.$_REQUEST['Itemid'];
		//}
		$today = date('m-d-Y');
		$link1 = $siteURL.'index.php?option=com_camassistant&controller=proposals&Itemid=148&task=vendor_proposal_form&view=proposals&amp;Prp_id='.$property_id.'&id='.$id.'&rfp_id='.$rfpno.'';
		 $sql = "UPDATE #__cam_rfpinfo SET rfp_type='Unawarded',unawardeddate='$today' WHERE id=".$rfpno;
		$db->Setquery($sql);
		$db->query();

		 $query6 = "SELECT U.email FROM  #__cam_vendor_proposals as C LEFT JOIN #__users as U ON U.id=C.proposedvendorid WHERE C.rfpno=".$rfpno;
	//	$query = "UPDATE #__cam_vendor_proposals SET proposaltype='Awarded' WHERE id=".$id;
		$db->setQuery( $query6 );
		$data6 = $db->loadObjectlist();
		for ($i=0, $n=count( $data6); $i < $n; $i++)
	{
	if ($data6[$i]->email== ''){
	//echo "anand";
	} else {
	$mails = $data6[$i]->email;
	//echo "<pre>"; print_r($data1[$i]);
				$mailfrom = 'support@myvendorcenter.com';
				$fromname = 'MyVendorCenter.com';
				$assignuseremail = $mails;
				$mailsubject = 'MyVendorCenter Team';
				 $message="SELECT cancel_rfp FROM #__emails where id='1'";
					$db->Setquery($message);
					$rmessage = $db->loadResult();
					$bodytext = str_replace('{VENDOR EMAIL}',$assignuseremail,$rmessage);
					$bodytext = str_replace('{RFP NUMBER}',$rfpno,$bodytext);
					$bodytext = str_replace('{CLICK HERE}','<a href="'.$link1.'">CLICK HERE</a>',$bodytext);
					$bodytext = str_replace('{CAM Firm}',$email,$bodytext);
					//$bodytext = str_replace('{GENERAL PROJECT INFORMATION}',$data['name'],$bodytext);
					$body=$bodytext;
				/*$body ='<p> Dear '.$assignuseremail.',</p>
<p>There has been an addendum to RFP '.$rfpno.' </p>
<p>Please <a href="'.$link1.'">CLICK HERE</a> to view/resubmit your now outdated proposal.</p>
<p>IMPORTANT: Your previously submitted proposal has been automatically marked as a "Draft/Unsubmitted" proposal. Please review the changes made by the Property Manager and update & resubmit your proposal accordingly. If you do not review and resubmit your proposal, it will not be considered (as it may be outdated). If the changes to the RFP are no longer of interest to your company, you may withdraw your Intent To Bid without penalty within 2 business days by calling 561-246-3830. Failure to submit a proposal before the new deadline will be penalized if an ITB is not withdrawn in time.</p>
<p>Thanks,</p>
<p>'.$email.'</p>';*/
//$body = html_entity_decode($body1);

//print_r($body);

				//$body = "the RFP has been withdrawn
	//<br/><br/>At Your Service,<br/><br/>
	//CAMassistant.com";
			JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, html_entity_decode($body),$mode = 1);
				//JUtility::sendMail($mailfrom, $fromname, $assignuseremail, $mailsubject, $body, $useractivation,$mode = 1);
		}
	}	 //exit;
		$msg='<span style="color:#FF0000;font-weight:bold;padding-left:15px;">RFP has been saved as '.strtoupper($rfp_type).' Successfully</span>';?>
		<script type="text/javascript">
		window.parent.location.href = '<?php echo $link;?>';
		window.parent.document.getElementById( 'sbox-window' ).close();
		</script>
		<?php
		exit;
	}

	function ajaxcounty(){
$state = $_REQUEST['State'];
$db=JFactory::getDBO();
 $countie = "SELECT * FROM #__cam_counties WHERE State='".$state."' ORDER BY County ";
		$db->setQuery($countie);
		$db->Query();
		$counties = $db->loadObjectList(); ?>
<option value="" >Select County</option>

		 	<?php
			foreach($counties as $county)
			{
			echo"<option value=".$county->id.">".$county->County."</option>";

			}
		exit; }

	function gainmanager(){
	$pid = $_REQUEST['pid'];
$db=JFactory::getDBO();
 $pmanagerid = "SELECT property_manager_id FROM #__cam_property WHERE id='".$pid."' ";
		$db->setQuery($pmanagerid);
		$db->Query();
		$mid = $db->loadResult();
 $pmanagerdetails = "SELECT name, lastname FROM #__users WHERE id='".$mid."' ";
		$db->setQuery($pmanagerdetails);
		$db->Query();
		$details = $db->loadObject();
		$name = $details->name.' '.$details->lastname;
		echo $name;
		exit;
	}
	
	function getphonenumber(){
	$pid = $_REQUEST['pid'];
$db=JFactory::getDBO();
 $pmanagerid = "SELECT property_manager_id FROM #__cam_property WHERE id='".$pid."' ";
		$db->setQuery($pmanagerid);
		$db->Query();
		$mid = $db->loadResult();
 $pmanagerdetails = "SELECT phone, extension FROM #__users WHERE id='".$mid."' ";
		$db->setQuery($pmanagerdetails);
		$db->Query();
		$details = $db->loadObject();
		$phone = $details->phone;
		if($details->extension){
		$phone = "P: ".$phone . "(x".$details->extension.")";
		}
		else{
		$phone = "P: ". $phone  ;
		}
		echo $phone;
		exit;
	}
	
	function getpmid(){
	$pid = $_REQUEST['pid'];
$db=JFactory::getDBO();
 $pmanagerid = "SELECT property_manager_id FROM #__cam_property WHERE id='".$pid."' ";
		$db->setQuery($pmanagerid);
		$db->Query();
		$mid = $db->loadResult();
 $pmanagerdetails = "SELECT id FROM #__users WHERE id='".$mid."' ";
		$db->setQuery($pmanagerdetails);
		$db->Query();
		$details = $db->loadObject();
		$name = $details->id;
		echo $name;
		exit;
	}
	/*function industries_Save()
	{
		//echo "5454554";exit;
		//session_destroy();
		session_start();
		$_SESSION['line_industries']='';
		$ind_ary = JRequest::getVar('cid','','post','array',REQUEST_ALLOWRAW);
		$ind = implode(',',$ind_ary);
		$_SESSION['line_industries'] = $ind;
		echo "<script language='javascript' type='text/javascript'>
		window.parent.location.reload();
		self.close();
		 </script>";
		 $_SESSION['line_industries'] = $ind;
		//$link = 'index.php?option=com_camassistant&controller=vendors&task=vendor_info';
		//$this->setRedirect( $link,$msg );
		exit;
	}*/
	
	//Function to filter the preferred vendors
	function filtervendors(){
	
	$db=JFactory::getDBO();
	$user=JFactory::getUser();
	$post['rfpid']	= JRequest::getVar('rfpid','');
	$closeinvite	= JRequest::getVar('var','');
	$_REQUEST['selectdvendors'] = array_keys(array_count_values($_REQUEST['selectdvendors'])); 
	$count = count($_REQUEST['selectdvendors']);
	if($count > 0){ 
	for($i=0; $i<$count; $i++){
		$post['rfpid']	= JRequest::getVar('rfpid','');
		$post['vendorid'] = $_REQUEST['selectdvendors'][$i];
		$post['publish'] = '0';
		$post['status'] = '0';
		$post['date'] = date('Y-m-d');
		if($closeinvite == 'closeinvite') {
		$no = '';
		}
		else {
		$no = 'no' ;
		}
		$insert_sql = "insert into #__rfp_invitations values ('','".$post['rfpid']."','".$post['vendorid']."','".$post['publish']."','".$post['status']."','".$post['date']."','".$no."')";
		$db->SetQuery($insert_sql);
		$db->query();
		
		$insert_avail = "insert into #__cam_vendor_availablejobs values ('','".$post['rfpid']."','".$post['vendorid']."','1','0','0','0')";
		$db->SetQuery($insert_avail);
		$db->query();	
	
		$today = date('m-d-Y');
		$insert_sqlITB = "insert into #__cam_vendor_proposals values ('0','','".$post['rfpid']."','','','','','".$post['vendorid']."','".$today."','ITB','0.00','',0.00,'','','admin')";
		$db->SetQuery($insert_sqlITB);
		$db->query();
	
		if($closeinvite == 'closeinvite') {
    $v_company = "SELECT u.company_name, v.email, v.ccemail, v.subscribe  FROM #__cam_vendor_company as u, #__users as v where u.user_id=".$post['vendorid']." and u.user_id=v.id ";
	$db->Setquery($v_company);
	$vendor_companyname = $db->loadObject();
	$v_companyname = $vendor_companyname->company_name ;
    $vemail = $vendor_companyname->email ;
	$ccemail = $vendor_companyname->ccemail ;
    $subscribe = $vendor_companyname->subscribe ;     
	$pdata = "SELECT u.property_name, v.projectName, v.proposalDueDate, v.proposalDueTime, v.cust_id FROM #__cam_property as u, #__cam_rfpinfo as v where u.id=v.property_id and v.id=".$post['rfpid']." ";
	$db->Setquery($pdata);
	$rfpdetails = $db->loadObject();
	//To get the company name
	$namemanager = "SELECT comp_name FROM #__cam_customer_companyinfo  where cust_id=".$rfpdetails->cust_id." ";
	$db->Setquery($namemanager);
	$managaercname = $db->loadResult();
    $rfptime = $rfpdetails->proposalDueDate.' '.$rfpdetails->proposalDueTime ;
        
    $customerdata = "SELECT u.comp_name FROM #__cam_customer_companyinfo as u, #__cam_rfpinfo as v where v.cust_id=u.cust_id and v.id=".$post['rfpid']." ";
	$db->Setquery($customerdata);
	$cust_coname = $db->loadResult();
	
	// To get the manager name
	$manager_name = "SELECT name, lastname, email FROM #__users where id=".$rfpdetails->cust_id." ";
	$db->Setquery($manager_name);
	$manager_details = $db->loadObject();
	$man_fullname = $manager_details->name.' '. $manager_details->lastname ;
	//Completed
	
	
    if($subscribe == 'yes'){
    $email_data = "SELECT introtext  FROM #__content where id='248' ";
	}
	else{
	$email_data = "SELECT introtext  FROM #__content where id='258' ";
	}
	$db->Setquery($email_data);
	$data = $db->loadResult();
                
    $body = str_replace('{VENDOR}',$v_companyname,$data);
	$body = str_replace('[RFP #]',$post['rfpid'],$body);
	$body = str_replace('{PNAME}',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[communityname]',str_replace('_',' ',$rfpdetails->property_name),$body);
	$body = str_replace('[managername]',$managaercname,$body);
	$body = str_replace('[Reference Name]',$rfpdetails->projectName,$body);
	$body = str_replace('{PROJECTNAME}',$rfptime,$body);
	$body = str_replace('{CAMFIRM}',$cust_coname,$body);
	$body = str_replace('{managerfullname}',$man_fullname,$body);
	
	//$mailfrom = 'support@myvendorcenter.com';
	$mailfrom = $manager_details->email ;
	$fromname = $cust_coname;
	$mailsubject = "You've received a Project Invitation";
    $support='vendoremails@myvendorcenter.com';
        
	JUtility::sendMail($mailfrom, $fromname, $vemail, $mailsubject, $body,$mode = 1);
    JUtility::sendMail($mailfrom, $fromname, $support, $mailsubject, $body,$mode = 1);
	//To send the mails to CC
	$cclist = explode(';',$ccemail);
		for($c=0; $c<=count($cclist); $c++){
		$listcc = $cclist[$c];
		if($listcc){
		$res = JUtility::sendMail($mailfrom, $fromname, $listcc, $mailsubject, $body,$mode = 1);
		}
		} 
	} //Close if condition
	//Completed	 
	/*$mesg = 'Vendors invited successfully.';
	$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=125' ;
	$this->setRedirect( $link,$mesg );*/
	
	}
	
	$mesg = "WARNING: Your request will not be submitted until you click the 'SUBMIT' button below";
	}
	else{
	$mesg = "WARNING: Your request will not be submitted until you click the 'SUBMIT' button below";
	}
	//To make the redirection link
	$db=JFactory::getDBO();
	$updaterfp="SELECT R.update_rfp,R.projectName,P.property_name,R.maxProposals,R.industry_id,R.property_id,R.choose_tasks FROM #__cam_rfpinfo as R LEFT JOIN #__cam_property as P ON P.id=R.property_id  WHERE R.id='".$post['rfpid']."'";
	$db->Setquery($updaterfp);
	$status12 = $db->loadObjectlist();
	if($closeinvite == 'closeinvite'){
	$mesg = 'Vendors invited successfully.';
	$link = 'index.php?option=com_camassistant&controller=rfpcenter&task=dashboard&Itemid=125' ;
	$this->setRedirect( $link,$mesg );
	}
	else{
	$link = 'index.php?option=com_camassistant&controller=rfp&industry_id='.$status12[0]->industry_id.'&property_id='.$status12[0]->property_id.'&show='.$show.'&rfp_type='.$post['rfp_type'].'&choose_tasks='.$status12[0]->choose_tasks.'&amount='.$amount.'&task=reviewrfp&rfpid='.$post['rfpid'].'&edittype='.$_REQUEST['edittype'].'&Itemid=199' ;
	$this->setRedirect( $link,$mesg );
	}  
	}
	
	//Function to get the industry special requirements
	function getspecialrequirements(){
		global $mainframe;
		$db=&JFactory::getDBO();
		$model = $this->getModel('rfp');
		$industryid = JRequest::getVar('industryid','');
		?>
<div class="lineitem_pan_row" style="background-color:#fff;">
<div class="lineitem_pan" style="border:none;">
	<table cellpadding="0" cellspacing="0" border="0">
	<p></p>
	<?php
	$generaldata = $model->getgeneralinsdata($industryid);
	$autodata = $model->getautoinsdata($industryid);
	$workdata = $model->getworkinsdata($industryid);
	$umbrelladata = $model->getumbrellainsdata($industryid);
	$licdata = $model->getlicinsdata($industryid);
	
	$master = $model->getmasterfirmaccount();
	
		$sql_per = "SELECT permission FROM #__cam_master_email_compliance_status where masterid='".$master."'";
		$db->Setquery($sql_per);
		$permission = $db->loadResult();

		$user = JFactory::getUSer();
		
		if($user->user_type == '13' && $user->accounttype != 'master'){
		$sql_master = "SELECT masterid FROM #__cam_masteraccounts where firmid='".$user->id."'";
		$db->Setquery($sql_master);
		$exmaster = $db->loadResult();
		}
		else if($user->user_type == '13' && $user->accounttype == 'master'){
		$exmaster = $user->id;
		}
		else{
		$sql_c = "SELECT comp_id FROM #__cam_customer_companyinfo where cust_id='".$user->id."'";
		$db->Setquery($sql_c);
		$cname = $db->loadResult();
		$sql_ma = "SELECT cust_id FROM #__cam_camfirminfo where id='".$cname."'";
		$db->Setquery($sql_ma);
		$firmad = $db->loadResult();
		$sql_master = "SELECT masterid FROM #__cam_masteraccounts where firmid='".$firmad."'";
		$db->Setquery($sql_master);
		$exmaster = $db->loadResult();
		}
		
		
	if($permission != 'yes' && $exmaster && $generaldata) { $general_main = 'checked="checked"'; $gen_class = 'styled_3';  
	?>
	<tr><td><input type="checkbox" value="yes" id="generalliability" class="<?php echo $gen_class; ?>" name="generalliability" <?php echo $general_main; ?> /></td><td><strong>General Liability</strong></td></tr>
	<?php } else if($permission == 'yes' || !$exmaster) { ?>
	<tr><td><input type="checkbox" value="yes" id="generalliability" class="" name="generalliability" <?php echo $general_main; ?> /></td><td><strong>General Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } else { ?>
	<tr><td><input type="checkbox" class="" disabled="disabled" /></td><td><strong>General Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php }
	 ?>
	<tr><td></td><td>
	<?php 
	if($permission != 'yes'  && $exmaster && $generaldata ) {
	?>
	<ul class="pre_general" style="pointer-events:none; list-style-type:none;">
		<?php if($generaldata->occur){ $selected_occur = 'checked'; $class = 'styled_3'; ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="occur" class="<?php echo $class; ?>" checked="<?php echo $selected_occur; ?>" /></td><td>&nbsp;Occur</td></tr></table></li>
		<?php } ?>
		<?php if($generaldata->each_occurrence){ ?>
		<li>Each Occurrence: <input type="text" value="<?php echo number_format($generaldata->each_occurrence,2); ?>" name="each_occurrence" /></li>
		<?php } ?>
		<?php if($generaldata->damage_retend){ ?>
		<li>Damage to Rented Premises: <input type="text" value="<?php echo number_format($generaldata->damage_retend,2); ?>" name="damage_retend" /></li>
		<?php } ?>
		<?php if($generaldata->med_expenses){ ?>
		<li>Med Expenses: <input type="text" value="<?php echo number_format($generaldata->med_expenses,2); ?>" name="med_expenses" /></li>
		<?php } ?>
		<?php if($generaldata->personal_inj){ ?>
		<li>Personal & Adv injury: <input type="text" value="<?php echo number_format($generaldata->personal_inj,2); ?>" name="personal_inj" /></li>
		<?php } ?>
		<?php if($generaldata->general_aggr){ ?>
		<li>General Aggregate: <input type="text" value="<?php echo number_format($generaldata->general_aggr,2); ?>" name="general_aggr" />
		<?php } ?>
		<?php if($generaldata->applies_to){ ?>
		<?php if($generaldata->applies_to == 'pol') 
			  $pols = 'checked="checked"';
		      else if($generaldata->applies_to == 'proj')
			  $proj = 'checked="checked"';
			  else if($generaldata->applies_to == 'loc')
			  $loc = 'checked="checked"';
		 ?>
		<table cellpadding="0" cellspacing="0"><tr><td><td>&nbsp;&nbsp;&nbsp;| Applies To: &nbsp;&nbsp;</td>
		<td><input type="radio" name="applies_to" value="pol" <?php echo $pols; ?>  /></td><td> Pol&nbsp;&nbsp; </td>
		<td><input type="radio" name="applies_to" value="proj" <?php echo $proj; ?> /></td><td> Proj&nbsp;&nbsp;</td>
		<td><input type="radio" name="applies_to" value="loc" <?php echo $loc; ?> /></td><td> Loc</td></tr></table></li>
		<?php } ?>
		<?php if($generaldata->products_aggr){ ?>
		<li>Products - COMP/OP Aggregate: <input type="text" value="<?php echo number_format($generaldata->products_aggr,2); ?>" name="products_aggr" /></li>
		<?php } ?>
		<?php if($generaldata->waiver_sub == 'yes'){ $waiv = 'checked'; $class_waiver_sub = 'styled_3'; ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver_sub" checked="<?php echo $waiv; ?>" class="<?php echo $class_waiver_sub; ?>" /></td><td> Waiver of Subrogation</td></tr></table></li>
		<?php } ?>
		<?php if($generaldata->primary_noncontr == 'yes'){ $prim = 'checked'; $class_primary_noncontr = 'styled_3';?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="primary_noncontr" checked="<?php echo $prim; ?>" class="<?php echo $class_primary_noncontr; ?>" /></td> <td>Primary Non-Contributory</td></tr></table></li>
		<?php } ?>
		<?php if($generaldata->additional_insured == 'yes'){ $add = 'checked'; $class_additional_insured = 'styled_3';?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="additional_insured" checked="<?php echo $add; ?>" class="<?php echo $class_additional_insured; ?>" /></td><td> List my Company as as "Additional Insured"</td></tr></table></li>
		<?php } ?>
		<?php if($generaldata->cert_holder == 'yes'){ $cert = 'checked'; $class_cert_holder = 'styled_3'; ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="cert_holder" checked="<?php echo $cert; ?>" class="<?php echo $class_cert_holder; ?>"  /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		<?php } ?>
		</ul>		
	<?php } 

	else if($permission == 'yes' || !$exmaster) { ?>
		<ul class="generaloptions" style="list-style-type:none; display:none; margin-top:-5px;">
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="occur" /></td><td>&nbsp;Occur</td></tr></table></li>
		<li>Each Occurrence: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="each_occurrence" id="each_occurrence" /></li>
		<li>Damage to Rented Premises: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="damage_retend" id="damage_retend" /></li>
		<li>Med Expenses: <input type="text"  onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);"value="" name="med_expenses" id="med_expenses" /></li>
		<li>Personal & Adv injury: <input type="text"  onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);"value="" name="personal_inj" id="personal_inj" /></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td valign="top">General Aggregate:&nbsp;</td><td> <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="general_aggr" id="general_aggr" /> </td>
		<td valign="top" style="padding-top:2px;">&nbsp;&nbsp;&nbsp;| Applies To:&nbsp;&nbsp; </td>
		<td valign="top" style="padding-top:2px;"><input type="radio" name="applies_to" value="pol" /></td><td valign="top" style="padding-top:2px;"> Pol&nbsp;&nbsp; </td>
		<td valign="top" style="padding-top:2px;"><input type="radio" name="applies_to" value="proj" /></td><td valign="top" style="padding-top:2px;"> Proj&nbsp;&nbsp;</td>
		<td valign="top" style="padding-top:2px;"><input type="radio" name="applies_to" value="loc" /></td><td valign="top" style="padding-top:2px;"> Loc</td></tr></table></li>
		<li>Products - COMP/OP Aggregate: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="products_aggr" id="products_aggr" /></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver_sub" /></td><td> Waiver of Subrogation</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="primary_noncontr" /></td><td> Primary Non-Contributory</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="additional_insured" /></td><td> List my Company as as "Additional Insured"</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="cert_holder" /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		<br />
		</ul>
		<?php }
	else{
	
	}	
	?>	
	</td>
		</td></tr>
	<tr id="generalliability_sub"></tr>
	<?php
	
		if($permission != 'yes'  && $exmaster && $autodata) { $auto_main = 'checked="checked"'; $class_auto="styled_3"; 
	?>
	<tr><td><input type="checkbox" value="yes" id="autoliability" class="<?php echo $class_auto; ?>" name="autoliability" <?php echo $auto_main; ?> /></td><td><strong>Auto Liability</strong></td></tr>
	<?php } else if($permission == 'yes'  || !$exmaster) { ?>
	<tr><td><input type="checkbox" value="yes" id="autoliability" class="" name="autoliability" <?php echo $auto_main; ?> /></td><td><strong>Auto Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } else {?>
	<tr><td><input type="checkbox" value="yes" id="autoliability" disabled="disabled" /></td><td><strong>Auto Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } ?>
	<tr><td></td><td>
	<?php if($permission != 'yes' && $exmaster && $autodata) {  ?>
	<ul class="pre_auto" style="pointer-events:none; list-style-type:none;">
		<?php 
				if($autodata->applies_to_any == 'any') {
			  $any = 'checked="checked"';
			  $class_any = 'styled_3';
			  }
		      if($autodata->applies_to_owned == 'owned') {
			  $owned = 'checked="checked"';
			  $class_owned = 'styled_3';
			  }
			  if ($autodata->applies_to_nonowned == 'nonowned') {
			  $nonowned = 'checked="checked"';
			  $class_nonowned = 'styled_3';
			  }
			  if ($autodata->applies_to_hired == 'hired') {
			  $hired = 'checked="checked"';
			  $class_hired = 'styled_3';
			  }
			  if ($autodata->applies_to_scheduled == 'scheduled'){
			  $scheduled = 'checked="checked"';
			  $class_scheduled = 'styled_3';
			  }
		?>
		<?php if($autodata->applies_to_any || $autodata->applies_to_owned || $autodata->applies_to_nonowned || $autodata->applies_to_hired || $autodata->applies_to_scheduled){ ?>
		<li>
		<table cellpadding="0" cellspacing="0"><tr><td>Applies To: &nbsp;&nbsp;&nbsp;</td>
		<?php if($autodata->applies_to_any) { ?><td><input type="checkbox" name="applies_to_any" class="<?php echo $class_any; ?>" value="any" <?php echo $any; ?>  /></td><td> Any&nbsp;&nbsp; </td><?php } ?>
		<?php if($autodata->applies_to_owned) { ?><td><input type="checkbox" name="applies_to_owned" class="<?php echo $class_owned; ?>" value="owned" <?php echo $owned; ?> /></td><td> Owned&nbsp;&nbsp;</td><?php } ?>
		<?php if($autodata->applies_to_nonowned) { ?><td><input type="checkbox" name="applies_to_nonowned" class="<?php echo $class_nonowned; ?>" value="nonowned" <?php echo $nonowned; ?> /></td><td> Non-Owned&nbsp;&nbsp;</td><?php } ?>
		<?php if($autodata->applies_to_hired) { ?><td><input type="checkbox" name="applies_to_hired" class="<?php echo $class_hired; ?>" value="hired" <?php echo $hired; ?> /></td><td> Hired&nbsp;&nbsp;</td><?php } ?>
		<?php if($autodata->applies_to_scheduled) { ?><td><input type="checkbox" name="applies_to_scheduled" class="<?php echo $class_scheduled; ?>" value="scheduled" <?php echo $scheduled; ?> /></td><td> Scheduled</td><?php } ?></tr></table>
		</li>
		<?php } ?>
		
		<?php if($autodata->combined_single){ ?>
		<li>Combined Single Limit: <input type="text" value="<?php echo number_format($autodata->combined_single,2); ?>" name="combined_single" /></li>
		<?php } ?>		
		<?php if($autodata->bodily_injusy_person){ ?>
		<li>Bodily Injury - Per Person: <input type="text" value="<?php echo number_format($autodata->bodily_injusy_person,2); ?>" name="bodily_injusy_person" /></li>
		<?php } ?>		
		<?php if($autodata->bodily_injusy_accident){ ?>
		<li>Bodily Injury - Per Accident: <input type="text" value="<?php echo number_format($autodata->bodily_injusy_accident,2); ?>" name="bodily_injusy_accident" /></li>
		<?php } ?>		
		<?php if($autodata->property_damage){ ?>
		<li>Property Damage - Per Accident: <input type="text" value="<?php echo number_format($autodata->property_damage,2); ?>" name="property_damage" /></li>
		<?php } ?>
		<?php if($autodata->waiver){ ?>
		<?php if($autodata->waiver == 'yes'){ $waiv = 'checked="checked"'; $class_waiver = 'styled_3'; }?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver" <?php echo $waiv; ?> class="<?php echo $class_waiver; ?>" /></td><td> Waiver of Subrogation</td></tr></table></li>
		<?php } ?>
		<?php if($autodata->primary){ ?>
		<?php if($autodata->primary == 'yes'){ $prim = 'checked="checked"'; $class_primary = 'styled_3';} ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="primary" <?php echo $prim; ?>  class="<?php echo $class_primary; ?>" /></td><td> Primary Non-Contributory</td></tr></table></li>
		<?php } ?>
		<?php if($autodata->additional_ins){ ?>
		<?php if($autodata->additional_ins == 'yes'){ $add = 'checked="checked"'; $class_additional_ins = 'styled_3';} ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="additional_ins" <?php echo $add; ?> class="<?php echo $class_additional_ins; ?>" /></td><td> List my Company as as "Additional Insured"</td></tr></table></li>
		<?php } ?>
		<?php if($autodata->cert_holder){ ?>
		<?php if($autodata->cert_holder == 'yes'){ $cert = 'checked="checked"'; $class_cert_holder2 = 'styled_3';} ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="cert_holder" <?php echo $cert; ?> class="<?php echo $class_cert_holder2; ?>"  /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		<?php } ?>
		</ul>
	<?php } else if($permission == 'yes'  || !$exmaster) { ?>
		<ul class="pre_auto" style="list-style-type:none; display:none; margin-top:-5px;">
		<li>
		<table cellpadding="0" cellspacing="0"><tr><td>Applies To: &nbsp;&nbsp;&nbsp;</td>
		<td><input type="checkbox" name="applies_to_any" value="any"  /></td><td> Any&nbsp;&nbsp; </td>
		<td><input type="checkbox" name="applies_to_owned" value="owned" /></td><td> Owned&nbsp;&nbsp;</td>
		<td><input type="checkbox" name="applies_to_nonowned" value="nonowned" /></td><td> Non-Owned&nbsp;&nbsp;</td>
		<td><input type="checkbox" name="applies_to_hired" value="hired" /></td><td> Hired&nbsp;&nbsp;</td>
		<td><input type="checkbox" name="applies_to_scheduled" value="scheduled" /></td><td> Scheduled</td></tr></table>
		</li>
		<li>Combined Single Limit: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="combined_single" id="combined_single" /></li>
		<li>Bodily Injury - Per Person: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="bodily_injusy_person" id="bodily_injusy_person" /></li>
		<li>Bodily Injury - Per Accident: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="bodily_injusy_accident" id="bodily_injusy_accident" /></li>
		<li>Property Damage - Per Accident: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="property_damage" id="property_damage" /></li>
		
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver" <?php echo $waiv; ?> class="" /></td><td>Waiver of Subrogation</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="primary" <?php echo $prim; ?>  class="" /></td><td> Primary Non-Contributory</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="additional_ins" <?php echo $add; ?> class="" /></td><td> List my Company as as "Additional Insured"</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="cert_holder" <?php echo $cert; ?> class=""  /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		<br />
		</ul>	
	
	<?php } else {  }?>
	</td></tr>
	<tr id="autoliability_sub"></tr>
	<?php
		if($permission != 'yes' && $exmaster && $workdata) { $work_main = 'checked="checked"'; $class_work="styled_3"; 
	?>
	<tr><td><input type="checkbox" value="yes" id="workersliability" class="<?php echo $class_work; ?>" name="workersliability" <?php echo $work_main; ?> /></td><td><strong>Worker`s Comp Policy/Employer`s Liability</strong></td></tr>
	<?php } else if($permission == 'yes'  || !$exmaster) { ?>
	<tr><td><input type="checkbox" value="yes" id="workersliability" class="" name="workersliability" /></td><td><strong>Worker`s Comp Policy/Employer`s Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } else { ?>
	<tr><td><input type="checkbox" value="yes" id="workersliability" disabled="disabled" /></td><td><strong>Worker`s Comp Policy/Employer`s Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } ?>
	<tr><td></td><td>
	<?php if($permission != 'yes'  && $exmaster && $workdata) {  ?>
	<ul class="pre_workers" style="pointer-events:none; list-style-type:none;">
		<?php 
		if($workdata->workers_not == 'not') {
		$not = 'checked="checked"';
		if($workdata->workers_not){ ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="radio" id="workers_not" name="workers_not" value="not" <?php echo $not; ?>  /></td><td> Worker`s Comp Exemptions NOT accepted</td></tr></table></li>
		<?php } ?>	
		<li><ul class="notaccepted" style="list-style-type:none;"><li>	
		<?php if($workdata->each_accident){ ?>
		<li>Each Accident: <input type="text" value="<?php echo number_format($workdata->each_accident,2); ?>" name="each_accident" /></li>
		<?php } ?>		
		<?php if($workdata->disease_policy){ ?>
		<li>Desease - Policy Limit: <input type="text" value="<?php echo number_format($workdata->disease_policy,2); ?>" name="disease_policy" /></li>
		<?php } ?>		
		<?php if($workdata->disease_eachemp){ ?>
		<li>Desease - Each Employee: <input type="text" value="<?php echo number_format($workdata->disease_eachemp,2); ?>" name="disease_eachemp" /></li>
		<?php } ?>
		<?php if($workdata->waiver_work){ ?>
		<?php if($workdata->waiver_work == 'yes'){ $waiver_work = 'checked="checked"'; $class_waiver_work = 'styled_3';}?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver_work" <?php echo $waiver_work; ?> class="<?php echo $class_waiver_work; ?>" /> </td><td>Waiver of Subrogation</td></tr></table></li>
		<?php } ?>
		<?php if($workdata->certholder_work){ ?>
		<?php if($workdata->certholder_work == 'yes'){ $certholder_work = 'checked="checked"'; $class_certholder_work = 'styled_3';} ?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="certholder_work" <?php echo $certholder_work; ?> class="<?php echo $class_certholder_work; ?>" /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		</li></ul></li>
		<?php } ?>
		<?php 
		}
		else if($workdata->workers_not == 'yes'){ 
		$workers_accepted = 'checked="styled_3"';
		?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="radio" id="workers_yes" name="workers_not" value="yes" <?php echo $workers_accepted; ?>  /></td><td> Worker`s Comp Exemptions accepted</td></tr></table>
		<p style="margin-left:-29px;">WARNING: Worker`s Comp. Exemption Certificates are commonly mistaken for a Worker`s Comp policy. Please be aware that this "exemption" does NOT offer the property manager/association/building owner any form of protection against liability for an injured worker`s loss of wages and/or medical expenses if an on-the-job injury occurs. Consult your legal advisor for your unique situation, as laws vary by jurisdiction.</p>
		</li>
		<?php } ?>
		</ul>
		<?php } elseif($permission == 'yes'  || !$exmaster) { ?>
		<ul class="pre_workers" style="list-style-type:none; display:none; margin-top:-5px;">
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="radio" id="workers_not" name="workers_not" value="not" /></td><td>Worker`s Comp Exemptions NOT accepted</td></tr></table></li>
		<li><ul class="notaccepted" style="list-style-type:none; display:none"><li>	
		<li>Each Accident: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="each_accident" id="each_accident" /></li>
		<li>Desease - Policy Limit: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="disease_policy" id="disease_policy" /></li>
		<li>Desease - Each Employee: <input type="text" onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);" value="" name="disease_eachemp" id="disease_eachemp" /></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="waiver_work" class="" /></td><td> Waiver of Subrogation</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="certholder_work" class="" /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		</li></ul></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="radio" id="workers_yes" name="workers_not" value="yes" /></td><td>Worker`s Comp Exemptions accepted</td></tr></table>
		<p style="margin-left:-29px;">WARNING: Worker`s Comp. Exemption Certificates are commonly mistaken for a Worker`s Comp policy. Please be aware that this "exemption" does NOT offer the property manager/association/building owner any form of protection against liability for an injured worker`s loss of wages and/or medical expenses if an on-the-job injury occurs. Consult your legal advisor for your unique situation, as laws vary by jurisdiction.</p>
		</li>
		<br />
		</ul>
		<?php } else { } ?>
	</td></tr>
	<tr id="workersliability_sub"></tr>
	<?php
		if($permission != 'yes'  && $exmaster && $umbrelladata) { $umb_main = 'checked="checked"'; $class_umb = 'styled_3'; 
	?>
	<tr><td><input type="checkbox" value="yes" id="umbrellaliability" class="<?php echo $class_umb; ?>" name="umbrellaliability" <?php echo $umb_main; ?> /></td><td><strong>Umbrella Liability</strong></td></tr>
	<?php } else if($permission == 'yes' || !$exmaster) { ?>
	<tr><td><input type="checkbox" value="yes" id="umbrellaliability" class="" name="umbrellaliability" /></td><td><strong>Umbrella Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } else { ?>
	<tr><td><input type="checkbox" value="yes" id="umbrellaliability" disabled="disabled"/></td><td><strong>Umbrella Liability</strong></td></tr>
	<tr height="15"></tr>
	<?php } ?>
	<tr><td></td><td>
		<?php if($permission != 'yes'  && $exmaster && $umbrelladata) {  ?>
		<ul class="pre_umbrella" style="pointer-events:none; list-style-type:none;">
		<?php if($umbrelladata->each_occur){ ?>
		<li>Each Occurrence: <input type="text" value="<?php echo number_format($umbrelladata->each_occur,2); ?>" name="each_occur" /></li>
		<?php } ?>		
		<?php if($umbrelladata->aggregate){ ?>
		<li>Aggregate: <input type="text" value="<?php echo number_format($umbrelladata->aggregate,2); ?>" name="aggregate" /></li>
		<?php } ?>	
		<?php if($umbrelladata->certholder_umbrella){ ?>
		<?php if($umbrelladata->certholder_umbrella == 'yes'){ $waiver_umbrella = 'checked="checked"'; $class_certholder_umbrella = 'styled'; }?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="certholder_umbrella" <?php echo $waiver_umbrella; ?> class="<?php echo $class_certholder_umbrella; ?>" /></td><td> MyVendorCenter listed as Cert. Holder</td></tr></table></li>
		<?php } ?>	
		</ul>
		<?php } elseif($permission == 'yes' || !$exmaster) { ?>
		<ul class="pre_umbrella" style="list-style-type:none; display:none; margin-top:-5px;">
		<li>Each Occurrence: <input type="text"  onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);"value="" name="each_occur" id="each_occur" /></li>
		<li>Aggregate: <input type="text" value=""  onKeyup="if(isNaN(parseInt(this.value))) { alert('Please enter valid number'); this.value=''; }" onClick="if(this.value == '0.00') this.value='';" onChange="javascript: add_commas_special(this,this.value);"name="aggregate" id="aggregate" /></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="certholder_umbrella" class="" /></td><td>MyVendorCenter listed as Cert. Holder</td></tr></table></li><br />
		</ul>
		<?php } else{ }?>
	</td></tr>
	<tr id="umbrellaliability_sub"></tr>
	<?php
		if($permission != 'yes' && $exmaster && $licdata) { $lic_main = 'checked="checked"'; $class_lic = 'styled_3';  
	?>
	<tr><td><input type="checkbox" value="yes" id="licensingliability" class="<?php echo $class_lic; ?>" name="licensingliability" <?php echo $lic_main; ?> /></td><td><strong>Licensing </strong></td></tr>
	<?php } else if($permission == 'yes' || !$exmaster) { ?>
	<tr><td><input type="checkbox" value="yes" id="licensingliability" class="" name="licensingliability"  /></td><td><strong>Licensing </strong></td></tr>
	<tr height="15"></tr>
	<?php } else { ?>
	<tr><td><input type="checkbox" value="yes" id="licensingliability" disabled="disabled"/></td><td><strong>Licensing </strong></td></tr>
	<tr height="15"></tr>
	<?php } ?>
	<tr><td></td><td>
	<?php if($permission != 'yes' && $exmaster && $licdata) {  ?>
		<ul class="pre_lic" style="pointer-events:none; list-style-type:none;">
		<?php if($licdata->professional){ ?>
		<?php if($licdata->professional == 'yes'){ $professional = 'checked="checked"'; $class_professional = 'styled_3';}?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="professional" <?php echo $professional; ?> class="<?php echo $class_professional; ?>" /></td><td> Professional License</td></tr></table></li>
		<?php } ?>		
		<?php if($licdata->occupational){ ?>
		<?php if($licdata->occupational == 'yes'){ $occupational = 'checked="checked"'; $class_occupational = 'styled_3';}?>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="occupational" <?php echo $occupational; ?> class="<?php echo $class_occupational; ?>" /></td><td> Occupational License</td></tr></table></li>
		<?php } ?>	
		</ul>
	<?php } elseif($permission == 'yes' || !$exmaster) { ?>	
		<ul class="pre_lic" style="list-style-type:none; display:none; margin-top:-5px;">
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="professional" class="" /></td><td>Professional License</td></tr></table></li>
		<li><table cellpadding="0" cellspacing="0"><tr><td><input type="checkbox" value="yes" name="occupational" class="" /></td><td> Occupational License</td></tr></table></li>
		</ul>
	<?php } else { } ?>
	</td></tr>
	
	<tr id="licensingliability_sub"></tr>	
	</table>
<input type="hidden" id="industryall" value="<?php echo $industryid; ?>" name="industry" />
</div>

<div class="clear"></div>
</div>
		<?php
		exit;
	  
	}
	//Completed
	function checkindustrystands(){
		global $mainframe;
		$db=&JFactory::getDBO();
		$industryid = JRequest::getVar('industryid','');
		$user = JFactory::getUSer();
		$sql12="SELECT vendors_meet_myproject FROM #__emails where id='1'";
		$db->Setquery($sql12);
		$data12 = $db->loadResult();
	
	}
	
	
	function saveinsurance($_REQUEST,$rfpid){
		$db=&JFactory::getDBO();	
	 	$user=JFactory::getUser();
		$industryid = JRequest::getVar('industry_id','');
		$generalliability = JRequest::getVar('generalliability','');
		$autoliability = JRequest::getVar('autoliability','');
		$workersliability = JRequest::getVar('workersliability','');
		$umbrellaliability = JRequest::getVar('umbrellaliability','');
		$licensingliability = JRequest::getVar('licensingliability','');
		
		$gen['masterid'] = $user->id ;
		$gen['rfpid'] = $rfpid;
		$gen['occur'] = JRequest::getVar('occur','');
		$gen['each_occurrence'] = JRequest::getVar('each_occurrence','');
		$gen['each_occurrence']	= str_replace(",","",$gen['each_occurrence']);
		$gen['damage_retend'] = JRequest::getVar('damage_retend','');
		$gen['damage_retend']	= str_replace(",","",$gen['damage_retend']);
		$gen['med_expenses'] = JRequest::getVar('med_expenses','');
		$gen['med_expenses']	= str_replace(",","",$gen['med_expenses']);
		$gen['personal_inj'] = JRequest::getVar('personal_inj','');
		$gen['personal_inj']	= str_replace(",","",$gen['personal_inj']);
		$gen['general_aggr'] = JRequest::getVar('general_aggr','');
		$gen['general_aggr']	= str_replace(",","",$gen['general_aggr']);
		$gen['applies_to'] = JRequest::getVar('applies_to','');
		$gen['products_aggr'] = JRequest::getVar('products_aggr','');
		$gen['products_aggr']	= str_replace(",","",$gen['products_aggr']);
		
		$gen['waiver_sub'] = JRequest::getVar('waiver_sub','');
		$gen['primary_noncontr'] = JRequest::getVar('primary_noncontr','');
		$gen['additional_insured'] = JRequest::getVar('additional_insured','');
		$gen['cert_holder'] = JRequest::getVar('cert_holder','');
		$gen['created_date'] = date('m-d-Y');
		
		//To insert the data 
		$model = $this->getModel('rfp');
			if($generalliability == 'yes'){
				$gen = $gen ;
			}
			else{
				$db=&JFactory::getDBO();	
				$query_d = "Delete FROM `#__cam_master_generalinsurance_standards_rfps`  WHERE masterid =".$user->id." and rfpid=".$rfpid." ";
				$db->setQuery($query_d);
				$db->Query();
			}
		
		if($generalliability == 'yes'){
				$check = $model->getcheckindustryinc($rfpid);
				
					if($check) { 
						$gen['id'] = $check ;
						$savingdata = $model->saveinsurance($gen);
					}
					else{
						$savingdata = $model->saveinsurance($gen);
					}
		}
		//To insert the auto data
		$auto['masterid'] = $user->id ;
		$auto['rfpid'] = $rfpid;
		
		$auto['applies_to_any'] = JRequest::getVar('applies_to_any','');
		$auto['applies_to_owned'] = JRequest::getVar('applies_to_owned','');
		$auto['applies_to_nonowned'] = JRequest::getVar('applies_to_nonowned','');
		$auto['applies_to_hired'] = JRequest::getVar('applies_to_hired','');
		$auto['applies_to_scheduled'] = JRequest::getVar('applies_to_scheduled','');
		
		$auto['combined_single'] = JRequest::getVar('combined_single','');
		$auto['combined_single']	= str_replace(",","",$auto['combined_single']);
		$auto['bodily_injusy_person'] = JRequest::getVar('bodily_injusy_person','');
		$auto['bodily_injusy_person']	= str_replace(",","",$auto['bodily_injusy_person']);
		$auto['bodily_injusy_accident'] = JRequest::getVar('bodily_injusy_accident','');
		$auto['bodily_injusy_accident']	= str_replace(",","",$auto['bodily_injusy_accident']);
		$auto['property_damage'] = JRequest::getVar('property_damage','');
		$auto['property_damage']	= str_replace(",","",$auto['property_damage']);
		
		$auto['waiver'] = JRequest::getVar('waiver','');
		$auto['primary'] = JRequest::getVar('primary','');
		$auto['additional_ins'] = JRequest::getVar('additional_ins','');
		$auto['cert_holder'] = JRequest::getVar('cert_holder','');
		$model = $this->getModel('rfp');
			if($autoliability == 'yes'){
				$auto = $auto ;
			}
			else{
				$db=&JFactory::getDBO();	
				$query_d = "Delete FROM `#__cam_master_autoinsurance_standards_rfps`  WHERE masterid =".$user->id." and rfpid=".$auto['rfpid']." ";
				$db->setQuery($query_d);
				$db->Query();
			}
		
		if($autoliability == 'yes'){
				$check = $model->getcheckautoinc($auto['rfpid']);		
					if($check) { 
						$auto['id'] = $check ;
						$savingdata = $model->saveautoinsurance($auto);
					}
					else{
						$savingdata = $model->saveautoinsurance($auto);
					}
		}	
		//Completed
		
		//To insert the workers data
		$work['masterid'] = $user->id ;
		$work['rfpid'] = $rfpid;
		$work['workers_not'] = JRequest::getVar('workers_not','');
		$work['each_accident'] = JRequest::getVar('each_accident','');
		$work['each_accident']	= str_replace(",","",$work['each_accident']);
		$work['disease_policy'] = JRequest::getVar('disease_policy','');
		$work['disease_policy']	= str_replace(",","",$work['disease_policy']);
		$work['disease_eachemp'] = JRequest::getVar('disease_eachemp','');
		$work['disease_eachemp']	= str_replace(",","",$work['disease_eachemp']);
		$work['property_damage'] = JRequest::getVar('property_damage','');
		$work['waiver_work'] = JRequest::getVar('waiver_work','');
		$work['certholder_work'] = JRequest::getVar('certholder_work','');
		$work['workers_accepted'] = JRequest::getVar('workers_accepted','');
		$model = $this->getModel('rfp');
			if($workersliability == 'yes'){
				$work = $work ;
			}
			else{
				$db=&JFactory::getDBO();	
				$query_d = "Delete FROM `#__cam_master_workers_standards_rfps`  WHERE masterid =".$user->id." and rfpid=".$work['rfpid']." ";
				$db->setQuery($query_d);
				$db->Query();
			}
		
		if($workersliability == 'yes'){
				$check = $model->getcheckworkinc($work['rfpid']);		
					if($check) { 
						$work['id'] = $check ;
						$savingdata = $model->saveworkinsurance($work);
					}
					else{
						$savingdata = $model->saveworkinsurance($work);
					}
		}	
		//Completed
		
		//To insert the umbrella data
		$umb['masterid'] = $user->id ;
		$umb['rfpid'] = $rfpid;
		$umb['each_occur'] = JRequest::getVar('each_occur','');
		$umb['each_occur']	= str_replace(",","",$umb['each_occur']);
		$umb['aggregate'] = JRequest::getVar('aggregate','');
		$umb['aggregate']	= str_replace(",","",$umb['aggregate']);
		$umb['certholder_umbrella'] = JRequest::getVar('certholder_umbrella','');
		$model = $this->getModel('rfp');
			if($umbrellaliability == 'yes'){
				$umb = $umb ;
			}
			else{
				$db=&JFactory::getDBO();	
				$query_d = "Delete FROM `#__cam_master_umbrellainsurance_standards_rfps`  WHERE masterid =".$user->id." and rfpid=".$umb['rfpid']." ";
				$db->setQuery($query_d);
				$db->Query();
			}
		if($umbrellaliability == 'yes'){
				$check = $model->getcheckumbinc($umb['rfpid']);		
					if($check) { 
						$umb['id'] = $check ;
						$savingdata = $model->saveumbinsurance($umb);
					}
					else{
						$savingdata = $model->saveumbinsurance($umb);
					}
					
		}	
		//Completed
		
		//To insert the LIC data
		$lic['masterid'] = $user->id ;
		$lic['rfpid'] = $rfpid;
		$lic['professional'] = JRequest::getVar('professional','');
		$lic['occupational'] = JRequest::getVar('occupational','');
		$model = $this->getModel('rfp');
		if($licensingliability == 'yes'){
		$lic = $lic ;
		}
		else{
		$db=&JFactory::getDBO();	
		$query_d = "Delete FROM `#__cam_master_licinsurance_standards_rfps`  WHERE masterid =".$user->id." and rfpid=".$lic['rfpid']." ";
		$db->setQuery($query_d);
		$db->Query();
		}
		if($licensingliability == 'yes'){
				$check = $model->getchecklicinc($lic['rfpid']);		
					if($check) { 
						$lic['id'] = $check ;
						$savingdata = $model->savelicinsurance($lic);
					}
					else{
						$savingdata = $model->savelicinsurance($lic);
					}
		}	
		//Completed
		return $savingdata ;
		
		 }
		
		function getimage(){
		$pid = $_REQUEST['pid'];
		$db=JFactory::getDBO();
		$pimage = "SELECT property_image FROM #__cam_property WHERE id='".$pid."' ";
		$db->Setquery($pimage);
		$filename = $db->loadResult();
		
		if( $filename ) {
		$path2 = $siteURL."components/com_camassistant/assets/images/property_pictures/";
		$path1 = $filename;
		$image = $path2.$path1;	
		$image = str_replace(' ','%20',$image);
		$apath= getimagesize($image);
		$height_orig=$apath[1];
		$width_orig=$apath[0];
		$aspect_ratio = (float) $height_orig / $width_orig;
		$thumb_width =440;
		$thumb_height = round($thumb_width * $aspect_ratio) ;
		if($thumb_height == 0){
		$thumb_height = '307';
		}		
	
		echo "<img  width=".$thumb_width." height=".$thumb_height." src='components/com_camassistant/assets/images/property_pictures/".$filename."'>";
		}
		else{ ?>
		<a href="javascript:void(0);" onclick="getpopuppics(<?php echo $pid; ?>);" ><img src="templates/camassistant_left/images/uopload.jpg"></a>
		
		<?php }
		exit;
		} 
		
		function savepropertyfile(){
		$pid = JRequest::getVar('pid','');
		$db=JFactory::getDBO();
		jimport('joomla.filesystem.file');
		jimport('joomla.user.helper');
		$files	=  JRequest::getVar( 'property_image', '', 'files', 'array' );
		$lastDot = strrpos($files['name'], ".");
		$files['name'] = str_replace(".", "", substr($files['name'], 0, $lastDot)) . substr($files['name'], $lastDot);
				$files1= str_replace(' ','_',$files['name']); 		
				$files1= str_replace('&','_',$files1); 		
				$files1= str_replace('#','_',$files1); 		
				$files1= str_replace('%','_',$files1); 	
				$files1= str_replace(',','_',$files1);
				
				$filename  = $files1;
				$extension = end(explode('.', $filename));
				$new       = $pid.'.'.$extension;
				$updateuser['image']	= $new;
				jimport('joomla.filesystem.file');
				$filename =$updateuser['image']; 
				$base_Dir = JPATH_COMPONENT.DS.'assets'.DS.'images'.DS.'property_pictures'.DS;
				$filepath = $base_Dir . $filename;  
				$post['image'] = $filename;
				if(file_exists($base_Dir . $filename)){ //echo 'in unlink';
				@unlink($base_Dir . $filename); }
				move_uploaded_file($_FILES['property_image']['tmp_name'], $filepath); 
			
		$path2 = $siteURL."components/com_camassistant/assets/images/property_pictures/";
		$path1 = $filename;
		$image = $path2.$path1;	
		$image = str_replace(' ','%20',$image);
		$apath= getimagesize($image);
		$height_orig=$apath[1];
		$width_orig=$apath[0];
		$aspect_ratio = (float) $height_orig / $width_orig;
		$thumb_width =423;
		$thumb_height = round($thumb_width * $aspect_ratio) ;
		if($thumb_height == 0){
		$thumb_height = '300';
		}
		
			$sql = "UPDATE #__cam_property SET property_image='".$filename."' where id='".$pid."'"; 
			$db->Setquery($sql);
			$db->query();
			echo "<script language='javascript' type='text/javascript'>
window.parent.document.getElementById('imagediv').innerHTML = '<img width=".$thumb_width." height=".$thumb_height." src=\'components/com_camassistant/assets/images/property_pictures/".$filename."\' />';
			 window.parent.document.getElementById( 'sbox-window' ).close();
			 </script>";
			exit;	
	}	
}
?>
	
